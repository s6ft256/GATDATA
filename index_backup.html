
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSE DATA MANAGEMENT</title>
    
    <!-- CDN for SheetJS (xlsx) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- CDN for Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
    <!-- Google Fonts for a modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        :root {
            --primary-color: #4f46e5; /* Indigo 600 */
            --primary-hover: #4338ca; /* Indigo 700 */
            --danger-color: #ef4444; /* Red 500 */
            --success-color: #22c55e; /* Green 500 */
            --warning-color: #f97316; /* Orange 500 */
            --background-color: #f7fbff; /* Slate 50 */
            --card-bg-color: #ffffff;
            --text-color: #334155; /* Slate 700 */
            --heading-color: #0f172a; /* Slate 900 */
            --border-color: #e2e8f0; /* Slate 200 */
            --subtle-text: #64748b; /* Slate 500 */
            --shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 0.75rem;
        }

        // Excel tab functions
        function handleExcelFile(file) {
            // Reset previous state
            excelPreviewSection.classList.add('hidden');
            
            // File validation
            const extension = file.name.split('.').pop().toLowerCase();
            if (!['xlsx', 'xls', 'csv'].includes(extension)) {
                showAlert('Unsupported file type. Please upload a .xlsx, .xls, or .csv file.', 'danger');
                return;
            }
            
            // File size validation (50MB limit)
            const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB in bytes
            if (file.size > MAX_FILE_SIZE) {
                showAlert(`File is too large. Maximum allowed size is 50MB. Your file is ${(file.size / (1024 * 1024)).toFixed(1)}MB.`, 'danger');
                return;
            }
            
            // Show processing message
            excelDropZone.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem; color: var(--subtle-text);">
                    <div class="spinner" style="width: 32px; height: 32px; border-width: 4px; border-top-color: var(--primary-color); border-right-color: transparent; border-bottom-color: transparent; border-left-color: transparent;"></div>
                    <p>Processing <strong>${file.name}</strong>...</p>
                </div>
            `;
            
            // Process file
            setTimeout(() => {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                            showAlert('The file appears to be empty or does not contain any sheets.', 'danger');
                            excelDropZone.innerHTML = `
                                <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 19.5H5.25A2.25 2.25 0 013 17.25z" />
                                </svg>
                                <p>Drag & drop your Excel file here, or <strong>click to upload</strong>.</p>
                                <small class="subtle-text">Supported formats: .xlsx, .xls, .csv</small>
                            `;
                            return;
                        }
                        
                        // Get data from first sheet
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: null });
                        
                        if (jsonData.length === 0) {
                            showAlert('The selected sheet is empty.', 'warning');
                            excelDropZone.innerHTML = `
                                <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 19.5H5.25A2.25 2.25 0 013 17.25z" />
                                </svg>
                                <p>Drag & drop your Excel file here, or <strong>click to upload</strong>.</p>
                                <small class="subtle-text">Supported formats: .xlsx, .xls, .csv</small>
                            `;
                            return;
                        }
                        
                        // Display preview
                        renderExcelPreview(jsonData);
                        excelPreviewSection.classList.remove('hidden');
                        
                        // Reset drop zone
                        excelDropZone.innerHTML = `
                            <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 19.5H5.25A2.25 2.25 0 013 17.25z" />
                            </svg>
                            <p>Drag & drop your Excel file here, or <strong>click to upload</strong>.</p>
                            <small class="subtle-text">Supported formats: .xlsx, .xls, .csv</small>
                            <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--success-color);"><strong>File loaded:</strong> ${file.name}</p>
                        `;
                        
                    } catch (error) {
                        console.error('Error parsing Excel file:', error);
                        showAlert(`Error parsing file: ${error.message}`, 'danger');
                        excelDropZone.innerHTML = `
                            <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 19.5H5.25A2.25 2.25 0 013 17.25z" />
                            </svg>
                            <p>Drag & drop your Excel file here, or <strong>click to upload</strong>.</p>
                            <small class="subtle-text">Supported formats: .xlsx, .xls, .csv</small>
                        `;
                    }
                };
                
                reader.onerror = () => {
                    showAlert('Error reading file. Please try again.', 'danger');
                    excelDropZone.innerHTML = `
                        <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 19.5H5.25A2.25 2.25 0 013 17.25z" />
                        </svg>
                        <p>Drag & drop your Excel file here, or <strong>click to upload</strong>.</p>
                        <small class="subtle-text">Supported formats: .xlsx, .xls, .csv</small>
                    `;
                };
                
                reader.readAsArrayBuffer(file);
            }, 500);
        }
        
        function renderExcelPreview(data) {
            if (!data || data.length === 0) {
                excelPreviewTable.innerHTML = '<thead><tr><th>No data to display.</th></tr></thead>';
                return;
            }
            
            // Get headers from first row
            const headers = Object.keys(data[0]);
            
            // Create table header
            const thead = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
            
            // Create table body with first 10 rows
            const tbody = `<tbody>${data.slice(0, 10).map(row => 
                `<tr>${headers.map(h => {
                    const value = row[h];
                    const displayValue = (value === null || value === undefined) ? '' : String(value);
                    return `<td>${displayValue}</td>`;
                }).join('')}</tr>`
            ).join('')}</tbody>`;
            
            excelPreviewTable.innerHTML = thead + tbody;
        }
        
        function processExcelData() {
            showAlert('Excel data processing functionality would be implemented here. In a full implementation, this would process and upload your data.', 'info');
        }
        
        // Excel tab functions have been moved to the script section
        
        function resetUI(isFullReset = false) {
            // Reset drop zone
            dropZone.innerHTML = `
                <input type="file" id="file-input" accept=".xlsx,.csv,.xlsm" class="hidden">
                <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 19.5H5.25A2.25 2.25 0 013 17.25z" />
                </svg>
                <p>Drag & drop your file here, or <strong>click to upload</strong>.</p>
                <small class="subtle-text">Supported formats: .xlsx, .csv, .xlsm</small>
            `;
            
            // Reset preview section
            previewSection.classList.add('hidden');
            headerInfo.classList.add('hidden');
            sheetTabsContainer.innerHTML = '';
            previewTable.innerHTML = '';
            targetTableContainer.classList.add('hidden');
            uploadBtn.disabled = true;
            btnText.textContent = 'Upload All Sheets';
            btnSpinner.classList.add('hidden');
            
            // Reset dashboard section
            totalSheetsStat.textContent = '0';
            totalRowsStat.textContent = '0';
            totalColsStat.textContent = '0';
            rowsPieChart.data.datasets[0].data = [];
            typesPieChart.data.datasets[0].data = [];
            rowsPieChart.update();
            typesPieChart.update();
            columnAnalysisSection.classList.add('hidden');
            analysisResults.classList.add('hidden');
            analysisPlaceholder.classList.remove('hidden');
            
            // Reset uploaded data section
            uploadedDataTable.innerHTML = '';
            
            // Reset Excel section
            excelDropZone.innerHTML = `
                <input type="file" id="excel-file-input" accept=".xlsx,.xls,.csv" class="hidden">
                <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 19.5H5.25A2.25 2.25 0 013 17.25z" />
                </svg>
                <p>Drag & drop your Excel file here, or <strong>click to upload</strong>.</p>
                <small class="subtle-text">Supported formats: .xlsx, .xls, .csv</small>
            `;
            excelPreviewSection.classList.add('hidden');
            excelPreviewTable.innerHTML = '';
            
            // Reset Firebase section
            collectionSelector.innerHTML = '<option value="">Select a collection...</option>';
            refreshCollectionsBtn.disabled = false;
            toggleEmptyCellsBtn.disabled = false;
            firebaseStatus.textContent = 'Firebase: Not Connected';
            firebaseStatus.style.backgroundColor = 'var(--danger-color)';
            collectionStats.classList.add('hidden');
            firebaseDataContainer.innerHTML = '';
            firebaseDataLoading.classList.add('hidden');
            firebaseDataTableContainer.classList.add('hidden');
            firebaseDataPagination.classList.add('hidden');
            noFirebaseData.classList.remove('hidden');
            
            // Reset theme toggle
            themeToggleCheckbox.checked = false;
            document.documentElement.classList.remove('dark');
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            background-image: linear-gradient(rgba(72, 151, 230, 0.85), rgba(129, 16, 114, 0.85)), url('https://www.technogenie.com/images/upload/sections/jobs/23-ingenierie-petrochimie.jpg');
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
        }

        #app-container {
            width: 100%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--heading-color);
            letter-spacing: -0.025em;
        }

        .header p {
            color: var(--subtle-text);
            font-size: 1.125rem;
            margin-top: 0.5rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .main-tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            padding-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .main-tabs::-webkit-scrollbar {
            height: 6px;
        }
        
        .main-tabs::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 3px;
        }

        .main-tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: var(--subtle-text);
            border-bottom: 3px solid transparent;
            margin-bottom: -1px;
            transition: all 0.3s ease;
            border-radius: 8px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-family: 'Roboto', 'Inter', sans-serif;
            letter-spacing: 0.5px;
        }

        .main-tab:hover:not(:disabled) {
            color: var(--text-color);
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .main-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(79, 70, 229, 0.3);
        }

        .main-tab:disabled {
            color: #cbd5e1;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.1);
        }

        .card {
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 2rem;
            border: 1px solid var(--border-color);
            transition: box-shadow 0.2s ease-in-out;
        }
        .card:hover {
             box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
        }
        .view-content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        
        .upload-icon {
            width: 48px; height: 48px; color: var(--primary-color);
            opacity: 0.7; transition: opacity 0.2s;
        }
        #drop-zone:hover .upload-icon { opacity: 1; }

        #drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
        #drop-zone.drag-over {
            background-color: #eef2ff; /* Indigo 50 */
            border-color: var(--primary-color);
        }
        #drop-zone.error {
            border-color: var(--danger-color);
            background-color: #fee2e2; /* Red 100 */
        }
        #drop-zone p { color: var(--subtle-text); }
        #drop-zone strong { color: var(--primary-hover); font-weight: 600; }
        #drop-zone .subtle-text { font-size: 0.875rem; }

        .preview-section h2 { 
            font-size: 1.5rem; 
            margin-bottom: 1rem; 
            color: var(--heading-color); 
        }

        .sheet-tabs-container {
            display: flex; flex-wrap: wrap; gap: 0.5rem;
            margin-bottom: 1rem; border-bottom: 1px solid var(--border-color);
        }
        .sheet-tab {
            padding: 0.5rem 1rem; border: none; background-color: transparent;
            cursor: pointer; border-radius: 0.5rem 0.5rem 0 0; font-weight: 500;
            color: var(--subtle-text); transition: background-color 0.2s, color 0.2s;
            border-bottom: 3px solid transparent; margin-bottom: -1px;
        }
        .sheet-tab:hover { color: var(--text-color); }
        .sheet-tab.active {
            color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: 600;
        }
        
        .table-container { max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-top: 1.5rem; }
        table { width: 100%; border-collapse: collapse; text-align: left; font-size: 0.9rem; }
        th, td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        thead th { 
            background-color: #f8fafc; position: sticky; top: 0; z-index: 10;
            font-weight: 600; color: var(--subtle-text); text-transform: uppercase;
            font-size: 0.75rem; letter-spacing: 0.05em; border-bottom: 2px solid var(--border-color);
        }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:nth-of-type(even) { background-color: #f8fafc; }
        tbody tr:hover { background-color: #f1f5f9; }
        td:empty, td:empty::before { content: ''; background-color: #f8f9fa; opacity: 0.5; }
        td.empty-cell { background-color: #f8f9fa; color: #9ca3af; font-style: italic; }
        
        /* Long header handling */
        .truncated-header {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: help;
            position: relative;
        }
        
        .truncated-header:hover {
            overflow: visible;
            white-space: normal;
            background-color: var(--primary-color);
            color: white;
            z-index: 1000;
            padding: 0.5rem;
            border-radius: 4px;
            box-shadow: var(--shadow-lg);
            position: absolute;
            min-width: max-content;
            max-width: 300px;
        }
        .button-container { display: flex; justify-content: flex-end; align-items: center; gap: 1rem; margin-top: 1.5rem; }
        #target-table-container { color: var(--subtle-text); font-size: 0.9rem; text-align: left; flex-grow: 1; }
        .btn {
            display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem;
            border: none; border-radius: 0.5rem; font-weight: 600; font-size: 1rem;
            cursor: pointer; transition: all 0.2s ease;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .btn-primary { background-color: var(--primary-color); color: white; box-shadow: var(--shadow); }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover); }
        .btn:disabled { 
            background-color: #a5b4fc; /* Indigo 300 */
            cursor: not-allowed; 
        }
        .alert {
            padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; display: none;
            opacity: 0; transition: opacity 0.3s ease; line-height: 1.5; word-break: break-word;
        }
        .alert pre { white-space: pre-wrap; font-family: inherit; font-size: 0.9em; margin-top: 0.5rem; }
        .alert.show { display: block; opacity: 1; }
        .alert-success { background-color: #dcfce7; color: #166534; border: 1px solid #0f4120; }
        .alert-danger { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .alert-info { background-color: #eef2ff; color: #3730a3; border: 1px solid #c7d2fe; }
        .spinner { width: 24px; height: 24px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }

/* Switch toggle styles */
.switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 34px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: var(--primary-color);
}

input:checked + .slider:before {
  transform: translateX(26px);
}

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Dashboard Styles */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
        .stat-card {
            background-color: var(--card-bg-color); border: 1px solid var(--border-color);
            padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow);
            border-left-width: 5px;
        }
        #sheets-stat-card { border-left-color: var(--primary-color); }
        #rows-stat-card { border-left-color: var(--success-color); }
        #cols-stat-card { border-left-color: var(--warning-color); }
        .stat-card h3 { color: var(--subtle-text); font-size: 1rem; font-weight: 500; margin-bottom: 0.5rem; }
        .stat-card p { font-size: 2.25rem; font-weight: 700; color: var(--heading-color); }
        
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .chart-container {
            background-color: var(--card-bg-color); border: 1px solid var(--border-color);
            padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow);
        }
        .chart-container h3 { 
            text-align: center; 
            margin-bottom: 1.5rem; 
            font-weight: 600;
            color: var(--heading-color); 
        }
        .chart-container canvas { max-height: 350px; width: 100% !important; }

        /* Column Analysis Styles */
        .analysis-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem; }
        .analysis-header h2 { color: var(--heading-color); }
        .analysis-controls { display: flex; gap: 1rem; flex-wrap: wrap; }
        .select-wrapper { display: flex; flex-direction: column; }
        .select-wrapper label { font-size: 0.9rem; color: var(--subtle-text); margin-bottom: 0.35rem; font-weight: 600; }
        .analysis-controls select {
            padding: 0.75rem 3rem 0.75rem 1.25rem; border-radius: 0.5rem; border: 1px solid var(--border-color);
            background-color: #fff; font-family: inherit; font-size: 1.1rem; min-width: 250px;
            cursor: pointer; font-weight: 500;
            appearance: none; -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }
        #analysis-results { display: grid; grid-template-columns: 280px 1fr; gap: 2rem; align-items: flex-start; }
        #analysis-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .analysis-stat-card { background-color: #f8fafc; border: 1px solid var(--border-color); padding: 1rem; border-radius: 0.5rem; }
        .analysis-stat-card h3 { font-size: 0.9rem; color: var(--subtle-text); font-weight: 500; margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .analysis-stat-card p { font-size: 1.75rem; font-weight: 700; color: var(--heading-color); word-break: break-word; }
        #analysis-chart-container { padding: 0; box-shadow: none; border: none; background: none; }
        .placeholder-text { text-align: center; color: var(--subtle-text); padding: 2rem 0; font-style: italic; }
        .auto-loading { 
            background: linear-gradient(90deg, transparent, rgba(79, 70, 229, 0.03), transparent);
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: 200px 0; }
        }

        /* Content section styles */
        .card h2 {
            color: var(--heading-color);
            margin-bottom: 1rem;
        }
        
        .card h3 {
            color: var(--heading-color);
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .card h4 {
            color: var(--text-color);
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .card p {
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        
        .card ul {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }
        
        .card li {
            margin-bottom: 0.5rem;
        }
        
        .card form input,
        .card form textarea,
        .card form select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-family: inherit;
            font-size: 1rem;
        }
        
        .hidden { display: none !important; }
        @media (max-width: 900px) { #analysis-results { grid-template-columns: 1fr; } }
        @media (max-width: 768px) {
            body { padding: 1rem; }
            .card { padding: 1.5rem; }
            .header h1 { font-size: 1.75rem; }
            .analysis-header { flex-direction: column; align-items: flex-start; }
            #analysis-stats-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
            
            /* More aggressive header truncation on mobile */
            .truncated-header {
                max-width: 120px;
            }
            
            /* Smaller table headers on mobile */
            th {
                font-size: 0.7rem;
                padding: 0.5rem 0.25rem;
            }
        }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="app-container">
        <header class="header">
            <h1 style="color: #ffffff; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); font-weight: 800; letter-spacing: 1px;">STAY UPDATED</h1>
            <p style="color: #e2e8f0; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); font-size: 1.2rem; max-width: 600px; margin: 0 auto;">Upload, Analyze, and send structured data to the backend.</p>
            <div style="position: absolute; top: 20px; right: 20px;">
                <label class="switch">
                    <input type="checkbox" id="theme-toggle-checkbox">
                    <span class="slider"></span>
                </label>
            </div>
        </header>

        <nav class="main-tabs">
            <button id="home-tab-btn" class="main-tab">Home</button>
            <button id="industry-tab-btn" class="main-tab">Industry Insights</button>
            <button id="news-tab-btn" class="main-tab">News</button>
            <button id="data-tab-btn" class="main-tab">Data</button>
            <button id="regional-tab-btn" class="main-tab">Regional Coverage</button>
            <button id="events-tab-btn" class="main-tab">Events</button>
            <button id="health-tab-btn" class="main-tab">Health & Nutrition</button>
            <button id="contact-tab-btn" class="main-tab">Contact Us</button>
            <button id="about-tab-btn" class="main-tab">About Us</button>
        </nav>

        <main>
            <div id="alert-container"></div>

            <!-- Data Tab Content with Sub-tabs -->
            <div id="data-view" class="view-content">
                <div class="card">
                    <nav class="main-tabs" style="margin-bottom: 1rem; border-bottom: none;">
                        <button id="ingest-subtab-btn" class="main-tab active">Ingest Tool</button>
                        <button id="dashboard-subtab-btn" class="main-tab" disabled>Dashboard</button>
                        <button id="uploaded-data-subtab-btn" class="main-tab" disabled>Uploaded Data</button>
                        <button id="excel-subtab-btn" class="main-tab">Excel</button>
                    </nav>
                    
                    <div id="data-content-container">
                        <div id="ingest-subview" class="view-content">
                            <div class="card">
                                <div id="drop-zone">
                                    <input type="file" id="file-input" accept=".xlsx,.csv,.xlsm" class="hidden">
                                    <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 19.5H5.25A2.25 2.25 0 013 17.25z" />
                                    </svg>
                                    <p>Drag & drop your file here, or <strong>click to upload</strong>.</p>
                                    <small class="subtle-text">Supported formats: .xlsx, .csv, .xlsm</small>
                                </div>
                            </div>
                            <div id="preview-section" class="card hidden">
                                <h2>Data Preview</h2>
                                <div id="header-info" class="alert alert-info hidden" style="margin-bottom: 1rem;">
                                    <strong>Smart Headers Detected:</strong> Column headers have been automatically cleaned and improved for better readability.
                                </div>
                                <div id="sheet-tabs" class="sheet-tabs-container"></div>
                                <div class="table-container">
                                    <table id="preview-table"></table>
                                </div>
                                <div class="button-container">
                                    <div id="target-table-container" class="hidden">
                                        <p>This sheet will target collection: <strong id="target-table-name"></strong></p>
                                    </div>
                                    <button id="upload-btn" class="btn btn-primary" disabled>
                                        <span id="btn-text">Upload All Sheets</span>
                                        <div id="btn-spinner" class="spinner hidden"></div>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div id="dashboard-subview" class="view-content hidden">
                            <!-- Overview Stats & Charts -->
                            <div class="stats-grid">
                                <div id="sheets-stat-card" class="stat-card">
                                    <h3>Total Sheets</h3>
                                    <p id="total-sheets-stat">0</p>
                                </div>
                                <div id="rows-stat-card" class="stat-card">
                                    <h3>Total Rows</h3>
                                    <p id="total-rows-stat">0</p>
                                </div>
                                <div id="cols-stat-card" class="stat-card">
                                    <h3>Total Columns</h3>
                                    <p id="total-cols-stat">0</p>
                                </div>
                            </div>
                            <div class="charts-grid">
                                <div class="chart-container">
                                    <h3>Row Distribution by Sheet</h3>
                                    <canvas id="rows-pie-chart"></canvas>
                                </div>
                                <div class="chart-container">
                                    <h3>Data Type Distribution</h3>
                                    <canvas id="types-pie-chart"></canvas>
                                </div>
                            </div>
                            <!-- Column Analysis Section -->
                            <div id="column-analysis-section" class="card hidden">
                                <div class="analysis-header">
                                    <h2>Column Analysis</h2>
                                    <div class="analysis-controls">
                                        <div class="select-wrapper">
                                            <label for="sheet-selector">Sheet</label>
                                            <select id="sheet-selector"></select>
                                        </div>
                                        <div class="select-wrapper">
                                            <label for="column-selector">Column</label>
                                            <select id="column-selector"></select>
                                        </div>
                                    </div>
                                </div>
                                <div id="analysis-results" class="hidden">
                                    <div id="analysis-stats-grid"></div>
                                    <div id="analysis-chart-container">
                                        <canvas id="analysis-chart"></canvas>
                                    </div>
                                </div>
                                <p id="analysis-placeholder" class="placeholder-text">Select a sheet and column to see a detailed analysis.</p>
                            </div>
                        </div>

                        <div id="uploaded-data-subview" class="view-content hidden">
                            <div class="card">
                                <h2>Uploaded Data</h2>
                                <p>View and manage your uploaded data here.</p>
                                <div id="uploaded-data-table" class="table-container"></div>
                            </div>
                        </div>

                        <div id="excel-subview" class="view-content hidden">
                            <div class="card">
                                <h2>Excel Data Processing</h2>
                                <p>Upload and process Excel files with advanced features.</p>
                                
                                <div class="stats-grid" style="margin-top: 1.5rem;">
                                    <div class="stat-card" style="border-left-color: #4f46e5;">
                                        <h3>Supported Formats</h3>
                                        <p>.xlsx, .xls, .csv</p>
                                    </div>
                                    <div class="stat-card" style="border-left-color: #10b981;">
                                        <h3>Max File Size</h3>
                                        <p>50 MB</p>
                                    </div>
                                    <div class="stat-card" style="border-left-color: #f97316;">
                                        <h3>Processing Speed</h3>
                                        <p>Fast & Efficient</p>
                                    </div>
                                </div>
                                
                                <div class="card" style="margin-top: 1.5rem;">
                                    <h3>Upload Excel File</h3>
                                    <div id="excel-drop-zone" style="border: 2px dashed var(--border-color); border-radius: var(--border-radius); padding: 2rem; text-align: center; cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease; margin-top: 1rem;">
                                        <input type="file" id="excel-file-input" accept=".xlsx,.xls,.csv" class="hidden">
                                        <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 19.5H5.25A2.25 2.25 0 013 17.25z" />
                                        </svg>
                                        <p>Drag & drop your Excel file here, or <strong>click to upload</strong>.</p>
                                        <small class="subtle-text">Supported formats: .xlsx, .xls, .csv</small>
                                    </div>
                                </div>
                                
                                <div id="excel-preview-section" class="card hidden" style="margin-top: 1.5rem;">
                                    <h3>Excel Data Preview</h3>
                                    <div class="table-container" style="margin-top: 1rem;">
                                        <table id="excel-preview-table"></table>
                                    </div>
                                    <div class="button-container" style="margin-top: 1.5rem;">
                                        <button id="excel-process-btn" class="btn btn-primary">Process Data</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                                <div class="analysis-header">
                                    <h2>Firebase Data Viewer</h2>
                                    <div class="analysis-controls">
                                        <div class="select-wrapper">
                                            <label for="collection-selector">Collection</label>
                                            <select id="collection-selector">
                                                <option value="">Select a collection...</option>
                                            </select>
                                        </div>
                                        <button id="refresh-collections-btn" class="btn btn-primary">
                                            <span>Refresh Collections</span>
                                        </button>
                                        <button id="toggle-empty-cells-btn" class="btn" style="background-color: var(--subtle-text); color: white;">
                                            <span>Show Empty Cells</span>
                                        </button>
                                        <div id="firebase-status" class="btn" style="background-color: var(--danger-color); color: white; cursor: default;">
                                            <span>Firebase: Not Connected</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="collection-stats" class="stats-grid hidden" style="margin-bottom: 1.5rem;">
                                    <div class="stat-card">
                                        <h3>Total Documents</h3>
                                        <p id="total-documents-stat">0</p>
                                    </div>
                                    <div class="stat-card">
                                        <h3>Collection Name</h3>
                                        <p id="collection-name-stat">-</p>
                                    </div>
                                    <div class="stat-card">
                                        <h3>Last Updated</h3>
                                        <p id="last-updated-stat">-</p>
                                    </div>
                                </div>
                                
                                <div id="firebase-data-container">
                                    <div id="firebase-data-loading" class="hidden" style="text-align: center; padding: 2rem;">
                                        <div class="spinner" style="width: 32px; height: 32px; border-width: 4px; margin: 0 auto 1rem;"></div>
                                        <p>Loading data from Firebase...</p>
                                    </div>
                                    
                                    <div id="firebase-data-table-container" class="table-container hidden">
                                        <table id="firebase-data-table"></table>
                                    </div>
                                    
                                    <div id="firebase-data-pagination" class="hidden" style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1rem;">
                                        <button id="prev-page-btn" class="btn" style="padding: 0.5rem 1rem;">Previous</button>
                                        <span id="page-info">Page 1 of 1</span>
                                        <button id="next-page-btn" class="btn" style="padding: 0.5rem 1rem;">Next</button>
                                    </div>
                                    
                                    <div id="no-firebase-data" class="placeholder-text">
                                        <p><strong>No data to display</strong></p>
                                        <p>uploaded data:</p>
                                        <ol style="text-align: left; display: inline-block; margin-top: 1rem;">
                                            <li>Upload some data using the "Ingest Tool" tab</li>
                                            <li>Click "Refresh Collections" button above</li>
                                            <li>Select a collection from the dropdown</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Home Tab Content -->
            <div id="home-view" class="view-content hidden">
                <div class="card" style="background-color: transparent; border: none; box-shadow: none; backdrop-filter: none; border-radius: 15px;">
                    <h2 style="color: white; text-shadow: 2px 2px 4px rgba(90, 5, 5, 0.7); text-align: center; margin-bottom: 1.5rem; font-weight: 700;">Health, Safety, and Environment (HSE) Management</h2>
                    <p style="color: #e2e8f0; text-shadow: 1px 1px 2px rgba(96, 5, 5, 0.7); text-align: center; max-width: 800px; margin: 0 auto 2rem; font-size: 1.1rem;">A comprehensive approach to managing workplace health, safety, and environmental risks for sustainable business operations.</p>
                    
                    <div style="margin-top: 2rem; text-align: center; position: relative; height: 100vh; border-radius: 12px; overflow: hidden; box-shadow: 0 12px 24px rgb(200, 182, 182); border: 1px solid rgb(163, 123, 123);">
                        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('https://hsewatch.com/wp-content/uploads/2022/07/Difference-Between-a-HSE-Officer-and-HSE-Manager-2048x1365.webp'); background-size: cover; background-position: center center; background-repeat: no-repeat; background-attachment: fixed;">
                        </div>
                        <div style="position: relative; z-index: 1; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: transparent; padding: 20px; box-sizing: border-box;">
                            <h3 style="margin: 0 0 20px 0; color: #ffffff; font-size: 2.8rem; font-weight: 800; text-align: center; text-shadow: 4px 4px 8px rgba(0,0,0,0.8); max-width: 90%; background-color: transparent; letter-spacing: 1px;">Enhance Your HSE Expertise</h3>
                            <p style="margin: 0; color: #fbf8fc; font-size: 1.6rem; font-weight: 600; text-align: center; text-shadow: 3px 3px 6px rgba(0,0,0,0.8); max-width: 90%; background-color: transparent; line-height: 1.4;">Stay updated with the latest in health, safety, and environmental management. Connect with professionals worldwide to drive safer, sustainable practices.</p>
                            <div style="margin-top: 30px; padding: 15px 30px; background-color: transparent; border-radius: 50px; backdrop-filter: none; border: 1px solid rgba(255, 255, 255, 0.05);">
                                <p style="margin: 0; color: rgb(255, 255, 255); font-weight: 600; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);">Explore Our HSE Solutions</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stats-grid" style="margin-top: 3rem; background-color: transparent; gap: 1.5rem;">
                        <div class="stat-card" style="border-left-color: #f5f5f7; background-color: transparent; backdrop-filter: none; border: 1px solid rgba(79, 70, 229, 0.1); border-radius: 10px; transition: transform 0.3s ease, box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 20px rgba(79, 70, 229, 0.1)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            <h3 style="color: #c7d2fe; text-shadow: 1px 1px 2px rgba(59, 56, 56, 0.7); font-weight: 600;">ISO 45001</h3>
                            <p style="color: white; text-shadow: 1px 1px 2px rgba(81, 73, 73, 0.7); font-weight: 500;">Occupational Health & Safety</p>
                        </div>
                        <div class="stat-card" style="border-left-color: #f8faf9; background-color: transparent; backdrop-filter: none; border: 1px solid rgba(16, 185, 129, 0.1); border-radius: 10px; transition: transform 0.3s ease, box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 20px rgba(16, 185, 129, 0.1)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            <h3 style="color: #6ee7b7; text-shadow: 1px 1px 2px rgba(89, 82, 82, 0.7); font-weight: 600;">ISO 14001</h3>
                            <p style="color: white; text-shadow: 1px 1px 2px rgba(81, 75, 75, 0.7); font-weight: 500;">Environmental Management</p>
                        </div>
                        <div class="stat-card" style="border-left-color: #f6f5f5; background-color: transparent; backdrop-filter: none; border: 1px solid rgba(249, 115, 22, 0.1); border-radius: 10px; transition: transform 0.3s ease, box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 20px rgba(249, 115, 22, 0.1)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            <h3 style="color: #fdba74; text-shadow: 1px 1px 2px rgba(86, 78, 78, 0.7); font-weight: 600;">Continuous Improvement</h3>
                            <p style="color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); font-weight: 500;">PDCA Cycle</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 3rem; background-color: transparent; padding: 2rem; border-radius: 15px; background: linear-gradient(rgba(72, 69, 69, 0.7), rgba(98, 74, 74, 0.7)), url('hse.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: fixed; background-origin: border-box; background-clip: border-box; border: 1px solid rgba(255, 255, 255, 0.05); position: relative; z-index: 2;">
                        <h3 style="color: white; text-shadow: 2px 2px 4px rgba(120, 115, 115, 0.7); text-align: center; margin-bottom: 1.5rem; font-weight: 700;">What is HSE Management?</h3>
                        <p style="color: #e2e8f0; text-shadow: 1px 1px 2px rgba(117, 111, 111, 0.7); max-width: 900px; margin: 0 auto 2rem; font-size: 1.1rem; line-height: 1.6;">HSE (Health, Safety, and Environment) management is a systematic approach to managing risks and ensuring compliance with health, safety, and environmental regulations. It encompasses policies, procedures, and practices designed to protect workers, the public, and the environment from harm.</p>
                        
                        <h3 style="margin-top: 2rem; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); text-align: center; font-weight: 700;">Key Elements of HSE Management System</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-top: 2rem; background-color: transparent;">
                            <div style="border-left: 4px solid #4f46e5; padding: 1.5rem; border-radius: 0 10px 10px 0; background: transparent; backdrop-filter: none; border: 1px solid rgba(79, 70, 229, 0.1); transition: transform 0.3s ease;" onmouseover="this.style.transform='scale(1.02)';" onmouseout="this.style.transform='scale(1)';">
                                <h4 style="margin-top: 0; color: #c7d2fe; display: flex; align-items: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); font-weight: 600;">
                                    <i class="bi bi-shield-lock" style="margin-right: 0.75rem; font-size: 1.5rem;"></i>Leadership & Commitment
                                </h4>
                                <p style="margin-bottom: 0; color: #e2e8f0; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);">Senior management must demonstrate strong commitment to HSE by establishing clear goals, allocating resources, and actively participating in HSE initiatives.</p>
                            </div>
                            
                            <div style="border-left: 4px solid #ef4444; padding: 1.5rem; border-radius: 0 10px 10px 0; background: transparent; backdrop-filter: none; border: 1px solid rgba(239, 68, 68, 0.1); transition: transform 0.3s ease;" onmouseover="this.style.transform='scale(1.02)';" onmouseout="this.style.transform='scale(1)';">
                                <h4 style="margin-top: 0; color: #fecaca; display: flex; align-items: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); font-weight: 600;">
                                    <i class="bi bi-exclamation-triangle" style="margin-right: 0.75rem; font-size: 1.5rem;"></i>Risk Management
                                </h4>
                                <p style="margin-bottom: 0; color: #e2e8f0; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);">Systematic identification, assessment, and control of workplace hazards to prevent accidents and minimize risks.</p>
                            </div>
                            
                            <div style="border-left: 4px solid #0ea5e9; padding: 1.5rem; border-radius: 0 10px 10px 0; background: transparent; backdrop-filter: none; border: 1px solid rgba(14, 165, 233, 0.1); transition: transform 0.3s ease;" onmouseover="this.style.transform='scale(1.02)';" onmouseout="this.style.transform='scale(1)';">
                                <h4 style="margin-top: 0; color: #bae6fd; display: flex; align-items: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); font-weight: 600;">
                                    <i class="bi bi-people" style="margin-right: 0.75rem; font-size: 1.5rem;"></i>Training & Competency
                                </h4>
                                <p style="margin-bottom: 0; color: #e2e8f0; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);">Ensuring all employees receive appropriate HSE training and possess the necessary skills to perform their duties safely.</p>
                            </div>
                            
                            <div style="border-left: 4px solid #8b5cf6; padding: 1.5rem; border-radius: 0 10px 10px 0; background: transparent; backdrop-filter: none; border: 1px solid rgba(139, 92, 246, 0.1); transition: transform 0.3s ease;" onmouseover="this.style.transform='scale(1.02)';" onmouseout="this.style.transform='scale(1)';">
                                <h4 style="margin-top: 0; color: #ddd6fe; display: flex; align-items: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); font-weight: 600;">
                                    <i class="bi bi-arrow-repeat" style="margin-right: 0.75rem; font-size: 1.5rem;"></i>Continuous Improvement
                                </h4>
                                <p style="margin-bottom: 0; color: #e2e8f0; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);">Regular monitoring, auditing, and review of HSE performance to identify opportunities for improvement and implement corrective actions.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 3rem; background-color: transparent; padding: 2rem; border-radius: 15px; background: transparent; backdrop-filter: none; border: 1px solid rgba(255, 255, 255, 0.05);">
                        <h3 style="color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); text-align: center; margin-bottom: 1.5rem; font-weight: 700;">The PDCA Cycle in HSE Management</h3>
                        <p style="color: #e2e8f0; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); max-width: 900px; margin: 0 auto 2rem; font-size: 1.1rem; line-height: 1.6; text-align: center;">The Plan-Do-Check-Act (PDCA) cycle is a fundamental framework for continuous improvement in HSE management systems:</p>
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 2rem; margin-top: 2rem; justify-content: center; background-color: transparent;">
                            <div style="flex: 1; min-width: 220px; text-align: center; padding: 2rem; border-radius: 15px; background: transparent; backdrop-filter: none; border: 1px solid rgba(79, 70, 229, 0.1); color: white; transition: transform 0.3s ease, box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-10px)'; this.style.boxShadow='0 15px 30px rgba(79, 70, 229, 0.1)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                <div style="font-size: 2.5rem; font-weight: 800; margin-bottom: 1rem; text-shadow: 3px 3px 6px rgba(0,0,0,0.7); color: #c7d2fe;">PLAN</div>
                                <p style="margin: 0; opacity: 0.9; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); font-weight: 500;">Establish objectives and processes to deliver results in accordance with customer requirements and organizational policy.</p>
                            </div>
                            
                            <div style="flex: 1; min-width: 220px; text-align: center; padding: 2rem; border-radius: 15px; background: transparent; backdrop-filter: none; border: 1px solid rgba(16, 185, 129, 0.1); color: white; transition: transform 0.3s ease, box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-10px)'; this.style.boxShadow='0 15px 30px rgba(16, 185, 129, 0.1)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                <div style="font-size: 2.5rem; font-weight: 800; margin-bottom: 1rem; text-shadow: 3px 3px 6px rgba(0,0,0,0.7); color: #6ee7b7;">DO</div>
                                <p style="margin: 0; opacity: 0.9; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); font-weight: 500;">Implement the plan, execute the processes, and make the product or deliver the service.</p>
                            </div>
                            
                            <div style="flex: 1; min-width: 220px; text-align: center; padding: 2rem; border-radius: 15px; background: transparent; backdrop-filter: none; border: 1px solid rgba(249, 115, 22, 0.1); color: white; transition: transform 0.3s ease, box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-10px)'; this.style.boxShadow='0 15px 30px rgba(249, 115, 22, 0.1)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                <div style="font-size: 2.5rem; font-weight: 800; margin-bottom: 1rem; text-shadow: 3px 3px 6px rgba(0,0,0,0.7); color: #fdba74;">CHECK</div>
                                <p style="margin: 0; opacity: 0.9; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); font-weight: 500;">Study the actual results and compare against the expected results to identify and analyze any differences.</p>
                            </div>
                            
                            <div style="flex: 1; min-width: 220px; text-align: center; padding: 2rem; border-radius: 15px; background: transparent; backdrop-filter: none; border: 1px solid rgba(139, 92, 246, 0.1); color: white; transition: transform 0.3s ease, box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-10px)'; this.style.boxShadow='0 15px 30px rgba(139, 92, 246, 0.1)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                <div style="font-size: 2.5rem; font-weight: 800; margin-bottom: 1rem; text-shadow: 3px 3px 6px rgba(0,0,0,0.7); color: #ddd6fe;">ACT</div>
                                <p style="margin: 0; opacity: 0.9; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); font-weight: 500;">Take action to continually improve process performance based on analysis and learning.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 3rem; background-color: transparent;">
                        <h3 style="color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); text-align: center; margin-bottom: 2rem; font-weight: 700;">Benefits of Effective HSE Management</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <ul style="margin: 0; padding-left: 1.5rem; background-color: transparent;">
                                <li style="color: #e2e8f0; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); margin-bottom: 1rem; padding: 1rem; background: transparent; backdrop-filter: none; border-radius: 10px; border-left: 4px solid #4f46e5;"><strong>Worker Protection:</strong> Reduced workplace injuries, illnesses, and fatalities</li>
                                <li style="color: #e2e8f0; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); margin-bottom: 1rem; padding: 1rem; background: transparent; backdrop-filter: none; border-radius: 10px; border-left: 4px solid #10b981;"><strong>Legal Compliance:</strong> Adherence to health, safety, and environmental regulations</li>
                                <li style="color: #e2e8f0; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); margin-bottom: 1rem; padding: 1rem; background: transparent; backdrop-filter: none; border-radius: 10px; border-left: 4px solid #f97316;"><strong>Cost Savings:</strong> Decreased insurance premiums, workers' compensation claims, and regulatory fines</li>
                            </ul>
                            <ul style="margin: 0; padding-left: 1.5rem; background-color: transparent;">
                                <li style="color: #e2e8f0; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); margin-bottom: 1rem; padding: 1rem; background: transparent; backdrop-filter: none; border-radius: 10px; border-left: 4px solid #0ea5e9;"><strong>Reputation Enhancement:</strong> Improved public image and stakeholder confidence</li>
                                <li style="color: #e2e8f0; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); margin-bottom: 1rem; padding: 1rem; background: transparent; backdrop-filter: none; border-radius: 10px; border-left: 4px solid #8b5cf6;"><strong>Operational Efficiency:</strong> Better resource utilization and reduced downtime</li>
                                <li style="color: #e2e8f0; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); margin-bottom: 1rem; padding: 1rem; background: transparent; backdrop-filter: none; border-radius: 10px; border-left: 4px solid #ec4899;"><strong>Sustainability:</strong> Minimized environmental impact and responsible resource management</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div style="margin-top: 3rem; padding: 2rem; border-radius: 15px; background: transparent; backdrop-filter: none; border: 1px solid rgba(79, 70, 229, 0.1); border-left: 4px solid rgba(79, 70, 229, 0.1);">
                        <h3 style="margin-top: 0; color: #c7d2fe; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); text-align: center; font-weight: 700;">International Standards</h3>
                        <p style="color: #e2e8f0; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); text-align: center; max-width: 900px; margin: 0 auto 1rem; font-size: 1.1rem;">Implementing internationally recognized standards such as ISO 45001 for occupational health and safety and ISO 14001 for environmental management provides organizations with proven frameworks for effective HSE management.</p>
                        <p style="margin-bottom: 0; color: #e2e8f0; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); text-align: center; max-width: 900px; margin: 1rem auto 0; font-size: 1.1rem;">These standards offer systematic approaches to identifying hazards, assessing risks, implementing controls, and continuously improving performance in health, safety, and environmental protection.</p>
                    </div>
                </div>
            </div>

            <!-- About Us Tab Content -->
            <div id="about-view" class="view-content hidden">
                <div class="card" style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.18); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
                    <nav class="main-tabs" style="margin-bottom: 1rem; border-bottom: none; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border-radius: 10px; padding: 5px;">
                        <button id="about-us-subtab-btn" class="main-tab active">About Us</button>
                        <button id="developer-subtab-btn" class="main-tab">Developer</button>
                        <button id="about-me-subtab-btn" class="main-tab">About Me</button>
                    </nav>
                    
                    <!-- About Us Sub-view -->
                    <div id="about-us-subview" class="view-content">
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <div style="width: 200px; height: 200px; border-radius: 50%; margin: 0 auto 1.5rem; overflow: hidden; border: 5px solid var(--primary-color); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                                <img src="https://tse1.mm.bing.net/th/id/OIP.qNX-82tHe-czpKb2ThxBcwHaHa?r=0&rs=1&pid=ImgDetMain&o=7&rm=3" alt="Profile Photo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                            </div>
                            <h2>MR. Ahmed abbas</h2>
                            <h5 style="color: var(--subtle-text); margin-top: 1rem;">EHS Manager at Trojan General Contracting LLC</h5>
                            <div style="margin-top: 1rem; max-width: 600px; margin-left: auto; margin-right: auto;">
                                <p>Trojan General Contracting LLC<br>
                                Universität Bremen<br>
                                Abu Dhabi Emirate, United Arab Emirates</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Developer Sub-view -->
                    <div id="developer-subview" class="view-content hidden">
                        <h2 style="text-align: center; margin-bottom: 2rem;">Developer Information</h2>
                        <p style="text-align: center; max-width: 800px; margin: 0 auto 2rem; color: var(--subtle-text);">Technical information about the Data Ingest Dashboard platform and development practices.</p>
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 1.5rem; margin-bottom: 2rem;">
                            <div style="flex: 1; min-width: 300px;">
                                <div class="card" style="height: 100%; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                                    <div class="card-body">
                                        <h4 class="card-title" style="color: var(--primary-color); font-weight: 600; border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; display: inline-block; margin-bottom: 1rem;">
                                            <i class="bi bi-stack" style="margin-right: 0.5rem;"></i>Technology Stack
                                        </h4>
                                        <ul style="list-style: none; padding: 0; margin: 0;">
                                            <li style="background: transparent; border: none; border-left: 3px solid var(--primary-color); margin-bottom: 0.5rem; border-radius: 0 5px 5px 0; transition: all 0.3s ease; padding: 0.5rem 1rem; display: flex; align-items: center;">
                                                <i class="bi bi-code-slash" style="color: var(--primary-color); margin-right: 0.75rem;"></i>
                                                <div>
                                                    <strong>Frontend:</strong> HTML5, CSS3, JavaScript, Chart.js
                                                </div>
                                            </li>
                                            <li style="background: transparent; border: none; border-left: 3px solid var(--primary-color); margin-bottom: 0.5rem; border-radius: 0 5px 5px 0; transition: all 0.3s ease; padding: 0.5rem 1rem; display: flex; align-items: center;">
                                                <i class="bi bi-server" style="color: var(--primary-color); margin-right: 0.75rem;"></i>
                                                <div>
                                                    <strong>Backend:</strong> Python Flask, Pandas, Scikit-learn
                                                </div>
                                            </li>
                                            <li style="background: transparent; border: none; border-left: 3px solid var(--primary-color); margin-bottom: 0.5rem; border-radius: 0 5px 5px 0; transition: all 0.3s ease; padding: 0.5rem 1rem; display: flex; align-items: center;">
                                                <i class="bi bi-database" style="color: var(--primary-color); margin-right: 0.75rem;"></i>
                                                <div>
                                                    <strong>Database:</strong> Google Firestore
                                                </div>
                                            </li>
                                            <li style="background: transparent; border: none; border-left: 3px solid var(--primary-color); margin-bottom: 0.5rem; border-radius: 0 5px 5px 0; transition: all 0.3s ease; padding: 0.5rem 1rem; display: flex; align-items: center;">
                                                <i class="bi bi-file-earmark-spreadsheet" style="color: var(--primary-color); margin-right: 0.75rem;"></i>
                                                <div>
                                                    <strong>File Processing:</strong> SheetJS (xlsx)
                                                </div>
                                            </li>
                                            <li style="background: transparent; border: none; border-left: 3px solid var(--primary-color); margin-bottom: 0.5rem; border-radius: 0 5px 5px 0; transition: all 0.3s ease; padding: 0.5rem 1rem; display: flex; align-items: center;">
                                                <i class="bi bi-box" style="color: var(--primary-color); margin-right: 0.75rem;"></i>
                                                <div>
                                                    <strong>Deployment:</strong> Docker, Heroku
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="flex: 1; min-width: 300px;">
                                <div class="card" style="height: 100%; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                                    <div class="card-body">
                                        <h4 class="card-title" style="color: var(--primary-color); font-weight: 600; border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; display: inline-block; margin-bottom: 1rem;">
                                            <i class="bi bi-diagram-3" style="margin-right: 0.5rem;"></i>Development Guidelines
                                        </h4>
                                        <ul style="list-style: none; padding: 0; margin: 0;">
                                            <li style="background: transparent; border: none; border-left: 3px solid var(--primary-color); margin-bottom: 0.5rem; border-radius: 0 5px 5px 0; transition: all 0.3s ease; padding: 0.5rem 1rem; display: flex; align-items: center;">
                                                <i class="bi bi-check-circle-fill" style="color: var(--success-color); margin-right: 0.75rem;"></i>
                                                <div>Follow RESTful API design principles</div>
                                            </li>
                                            <li style="background: transparent; border: none; border-left: 3px solid var(--primary-color); margin-bottom: 0.5rem; border-radius: 0 5px 5px 0; transition: all 0.3s ease; padding: 0.5rem 1rem; display: flex; align-items: center;">
                                                <i class="bi bi-check-circle-fill" style="color: var(--success-color); margin-right: 0.75rem;"></i>
                                                <div>Implement proper error handling and logging</div>
                                            </li>
                                            <li style="background: transparent; border: none; border-left: 3px solid var(--primary-color); margin-bottom: 0.5rem; border-radius: 0 5px 5px 0; transition: all 0.3s ease; padding: 0.5rem 1rem; display: flex; align-items: center;">
                                                <i class="bi bi-check-circle-fill" style="color: var(--success-color); margin-right: 0.75rem;"></i>
                                                <div>Ensure data validation and sanitization</div>
                                            </li>
                                            <li style="background: transparent; border: none; border-left: 3px solid var(--primary-color); margin-bottom: 0.5rem; border-radius: 0 5px 5px 0; transition: all 0.3s ease; padding: 0.5rem 1rem; display: flex; align-items: center;">
                                                <i class="bi bi-check-circle-fill" style="color: var(--success-color); margin-right: 0.75rem;"></i>
                                                <div>Maintain consistent code style and documentation</div>
                                            </li>
                                            <li style="background: transparent; border: none; border-left: 3px solid var(--primary-color); margin-bottom: 0.5rem; border-radius: 0 5px 5px 0; transition: all 0.3s ease; padding: 0.5rem 1rem; display: flex; align-items: center;">
                                                <i class="bi bi-check-circle-fill" style="color: var(--success-color); margin-right: 0.75rem;"></i>
                                                <div>Write unit tests for all new functionality</div>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                            <div class="card-body">
                                <h4 class="card-title" style="color: var(--primary-color); font-weight: 600; border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; display: inline-block; margin-bottom: 1rem;">
                                    <i class="bi bi-link-45deg" style="margin-right: 0.5rem;"></i>API Endpoints
                                </h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                                    <div style="border-left: 3px solid var(--primary-color); padding: 1rem; border-radius: 0 5px 5px 0; background: rgba(79, 70, 229, 0.05);">
                                        <h5 style="margin-top: 0; color: var(--primary-color); display: flex; align-items: center;">
                                            <i class="bi bi-arrow-right-circle" style="margin-right: 0.5rem;"></i>POST /api/predict
                                        </h5>
                                        <p style="margin-bottom: 0;">Machine learning prediction endpoint for data analysis and forecasting.</p>
                                    </div>
                                    
                                    <div style="border-left: 3px solid var(--primary-color); padding: 1rem; border-radius: 0 5px 5px 0; background: rgba(79, 70, 229, 0.05);">
                                        <h5 style="margin-top: 0; color: var(--primary-color); display: flex; align-items: center;">
                                            <i class="bi bi-arrow-right-circle" style="margin-right: 0.5rem;"></i>POST /api/process
                                        </h5>
                                        <p style="margin-bottom: 0;">Data processing and cleaning endpoint for structured data transformation.</p>
                                    </div>
                                    
                                    <div style="border-left: 3px solid var(--primary-color); padding: 1rem; border-radius: 0 5px 5px 0; background: rgba(79, 70, 229, 0.05);">
                                        <h5 style="margin-top: 0; color: var(--primary-color); display: flex; align-items: center;">
                                            <i class="bi bi-arrow-right-circle" style="margin-right: 0.5rem;"></i>POST /api/visualize
                                        </h5>
                                        <p style="margin-bottom: 0;">Data visualization endpoint for creating interactive charts and graphs.</p>
                                    </div>
                                    
                                    <div style="border-left: 3px solid var(--primary-color); padding: 1rem; border-radius: 0 5px 5px 0; background: rgba(79, 70, 229, 0.05);">
                                        <h5 style="margin-top: 0; color: var(--primary-color); display: flex; align-items: center;">
                                            <i class="bi bi-arrow-right-circle" style="margin-right: 0.5rem;"></i>POST /api/upload-to-firestore
                                        </h5>
                                        <p style="margin-bottom: 0;">Direct data upload to Firestore for persistent storage and retrieval.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- About Me Sub-view -->
                    <div id="about-me-subview" class="view-content hidden">
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <div style="width: 200px; height: 200px; border-radius: 50%; margin: 0 auto 1.5rem; overflow: hidden; border: 5px solid var(--primary-color); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                                <img src="Elius.jpg" alt="Profile Photo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                            </div>
                            <h2>ELIUS D.A</h2>
                            <h5 style="color: var(--subtle-text);">HSE Professional & Developer</h5>
                            <div style="margin: 1.5rem 0;">
                                <a href="https://wa.me/971563892557" target="_blank" style="display: inline-block; margin: 0 0.5rem 0.5rem 0; border-radius: 50px; padding: 0.5rem 1.2rem; transition: all 0.3s ease; background-color: var(--success-color); color: white; text-decoration: none;">
                                    <i class="bi bi-whatsapp" style="margin-right: 0.5rem;"></i>WhatsApp
                                </a>
                                <a href="mailto:niwamanyaelius95@gmail.com" target="_blank" style="display: inline-block; margin: 0 0.5rem 0.5rem 0; border-radius: 50px; padding: 0.5rem 1.2rem; transition: all 0.3s ease; background-color: var(--primary-color); color: white; text-decoration: none;">
                                    <i class="bi bi-envelope" style="margin-right: 0.5rem;"></i>Email
                                </a>
                                <a href="https://www.linkedin.com/in/elius-niwamanya-026228187/" target="_blank" style="display: inline-block; margin: 0 0.5rem 0.5rem 0; border-radius: 50px; padding: 0.5rem 1.2rem; transition: all 0.3s ease; background-color: var(--primary-color); color: white; text-decoration: none;">
                                    <i class="bi bi-linkedin" style="margin-right: 0.5rem;"></i>LinkedIn
                                </a>
                            </div>
                        </div>

                        <div style="display: flex; flex-wrap: wrap; gap: 1.5rem;">
                            <div style="flex: 1; min-width: 300px;">
                                <div class="card" style="height: 100%; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                                    <div class="card-body">
                                        <h4 class="card-title" style="color: var(--primary-color); font-weight: 600; border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; display: inline-block; margin-bottom: 1rem;">
                                            <i class="bi bi-person-lines-fill" style="margin-right: 0.5rem;"></i>Professional Profile
                                        </h4>
                                        <ul style="list-style: none; padding: 0; margin: 0;">
                                            <li style="background: transparent; border: none; border-left: 3px solid var(--primary-color); margin-bottom: 0.5rem; border-radius: 0 5px 5px 0; transition: all 0.3s ease; padding: 0.5rem 1rem;">
                                                <i class="bi bi-check-circle-fill" style="color: var(--success-color); margin-right: 0.5rem;"></i>
                                                Lifting Supervisor
                                            </li>
                                            <li style="background: transparent; border: none; border-left: 3px solid var(--primary-color); margin-bottom: 0.5rem; border-radius: 0 5px 5px 0; transition: all 0.3s ease; padding: 0.5rem 1rem;">
                                                <i class="bi bi-check-circle-fill" style="color: var(--success-color); margin-right: 0.5rem;"></i>
                                                HSE Professional
                                            </li>
                                            <li style="background: transparent; border: none; border-left: 3px solid var(--primary-color); margin-bottom: 0.5rem; border-radius: 0 5px 5px 0; transition: all 0.3s ease; padding: 0.5rem 1rem;">
                                                <i class="bi bi-check-circle-fill" style="color: var(--success-color); margin-right: 0.5rem;"></i>
                                                Web Developer
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div style="flex: 1; min-width: 300px;">
                                <div class="card" style="height: 100%; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                                    <div class="card-body">
                                        <h4 class="card-title" style="color: var(--primary-color); font-weight: 600; border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; display: inline-block; margin-bottom: 1rem;">
                                            <i class="bi bi-telephone-fill" style="margin-right: 0.5rem;"></i>Contact Information
                                        </h4>
                                        <ul style="list-style: none; padding: 0; margin: 0;">
                                            <li style="display: flex; align-items: center; padding: 0.5rem 1rem;">
                                                <i class="bi bi-telephone-fill" style="color: var(--primary-color); margin-right: 1rem;"></i>
                                                <div>
                                                    <h6 style="margin-bottom: 0;">Phone</h6>
                                                    <p style="margin-bottom: 0;">+971 56 389 2557</p>
                                                </div>
                                            </li>
                                            <li style="display: flex; align-items: center; padding: 0.5rem 1rem;">
                                                <i class="bi bi-envelope-fill" style="color: var(--primary-color); margin-right: 1rem;"></i>
                                                <div>
                                                    <h6 style="margin-bottom: 0;">Email</h6>
                                                    <p style="margin-bottom: 0;">niwamanyaelius95@gmail.com</p>
                                                </div>
                                            </li>
                                            <li style="display: flex; align-items: center; padding: 0.5rem 1rem;">
                                                <i class="bi bi-geo-alt-fill" style="color: var(--primary-color); margin-right: 1rem;"></i>
                                                <div>
                                                    <h6 style="margin-bottom: 0;">Location</h6>
                                                    <p style="margin-bottom: 0;">Dubai, UAE</p>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- News Tab Content -->
            <div id="news-view" class="view-content hidden">
                <div class="card">
                    <h2>Latest News</h2>
                    <p>Stay up-to-date with the latest developments and announcements.</p>
                    
                    <div style="margin-top: 2rem;">
                        <div style="border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;">
                            <h3>New Machine Learning Features Released</h3>
                            <p style="color: var(--subtle-text); font-size: 0.9rem;">September 15, 2025</p>
                            <p>We've added advanced ML capabilities including automated model selection and improved prediction accuracy.</p>
                        </div>
                        
                        <div style="border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;">
                            <h3>Dashboard Performance Improvements</h3>
                            <p style="color: var(--subtle-text); font-size: 0.9rem;">August 28, 2025</p>
                            <p>Significant performance enhancements have been implemented to provide faster data processing and visualization.</p>
                        </div>
                        
                        <div style="border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;">
                            <h3>Expanded File Format Support</h3>
                            <p style="color: var(--subtle-text); font-size: 0.9rem;">August 10, 2025</p>
                            <p>Now supporting additional file formats including .xlsm for enhanced Excel compatibility.</p>
                        </div>
                        
                        <div>
                            <h3>Security Update</h3>
                            <p style="color: var(--subtle-text); font-size: 0.9rem;">July 22, 2025</p>
                            <p>Implemented enhanced security protocols to ensure your data remains protected at all times.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Regional Coverage Tab Content -->
            <div id="regional-view" class="view-content hidden">
                <div class="card">
                    <h2>Regional Coverage</h2>
                    <p>Explore our data processing capabilities across different regions.</p>
                    
                    <div style="margin-top: 2rem;">
                        <div class="stats-grid">
                            <div class="stat-card" style="border-left-color: #4f46e5;">
                                <h3>North America</h3>
                                <p>98% Coverage</p>
                            </div>
                            <div class="stat-card" style="border-left-color: #10b981;">
                                <h3>Europe</h3>
                                <p>95% Coverage</p>
                            </div>
                            <div class="stat-card" style="border-left-color: #f97316;">
                                <h3>Asia Pacific</h3>
                                <p>92% Coverage</p>
                            </div>
                            <div class="stat-card" style="border-left-color: #8b5cf6;">
                                <h3>Latin America</h3>
                                <p>87% Coverage</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <h3>Regional Features</h3>
                        <p>Our platform is optimized for regional compliance requirements and supports multiple languages for a global user base.</p>
                        
                        <div style="margin-top: 1rem;">
                            <h4>Data Centers</h4>
                            <ul style="padding-left: 1.5rem;">
                                <li>New York, USA</li>
                                <li>London, UK</li>
                                <li>Singapore, Singapore</li>
                                <li>Sydney, Australia</li>
                                <li>Frankfurt, Germany</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Industry Insights Tab Content -->
            <div id="industry-view" class="view-content hidden">
                <div class="card">
                    <h2>Industry Insights</h2>
                    <p>Data-driven insights across various industries.</p>
                    
                    <div style="margin-top: 2rem;">
                        <div style="border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;">
                            <h3>Financial Services</h3>
                            <p>Advanced fraud detection algorithms have reduced false positives by 35% while maintaining 99.8% accuracy in identifying fraudulent transactions.</p>
                        </div>
                        
                        <div style="border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;">
                            <h3>Healthcare</h3>
                            <p>Predictive models for patient readmission have improved hospital resource planning, reducing readmission rates by 22%.</p>
                        </div>
                        
                        <div style="border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;">
                            <h3>Retail</h3>
                            <p>Inventory optimization using machine learning has reduced overstock by 28% and stockouts by 41% across retail chains.</p>
                        </div>
                        
                        <div>
                            <h3>Manufacturing</h3>
                            <p>Predictive maintenance models have decreased unplanned downtime by 33% and extended equipment lifespan by 18%.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Events Tab Content -->
            <div id="events-view" class="view-content hidden">
                <div class="card">
                    <h2>Upcoming Events</h2>
                    <p>Join us at industry events and conferences.</p>
                    
                    <div style="margin-top: 2rem;">
                        <div style="border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;">
                            <h3>Data Science Summit 2025</h3>
                            <p style="color: var(--subtle-text); font-size: 0.9rem;">October 15-17, 2025 | San Francisco, CA</p>
                            <p>Join our team at the premier data science conference where we'll be presenting our latest research on automated data processing.</p>
                        </div>
                        
                        <div style="border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;">
                            <h3>Cloud Innovation Conference</h3>
                            <p style="color: var(--subtle-text); font-size: 0.9rem;">November 5-6, 2025 | New York, NY</p>
                            <p>Discover how our platform leverages cloud technologies for scalable data processing solutions.</p>
                        </div>
                        
                        <div>
                            <h3>AI in Business Workshop</h3>
                            <p style="color: var(--subtle-text); font-size: 0.9rem;">December 12, 2025 | Online</p>
                            <p>Learn how to integrate machine learning models into your business processes with our hands-on workshop.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Health & Nutrition Tab Content -->
            <div id="health-view" class="view-content hidden">
                <div class="card">
                    <h2>Health & Nutrition</h2>
                    <p>Explore data-driven insights in health and nutrition.</p>
                    
                    <div style="margin-top: 2rem; display: flex; flex-wrap: wrap; gap: 1.5rem;">
                        <div class="stat-card" style="border-left-color: #4f46e5; flex: 1; min-width: 200px;">
                            <h3>Nutrition Studies</h3>
                            <p>127</p>
                        </div>
                        <div class="stat-card" style="border-left-color: #10b981; flex: 1; min-width: 200px;">
                            <h3>Health Datasets</h3>
                            <p>42</p>
                        </div>
                        <div class="stat-card" style="border-left-color: #f97316; flex: 1; min-width: 200px;">
                            <h3>Research Papers</h3>
                            <p>89</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <h3>Latest Research</h3>
                        <div style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 1.5rem;">
                            <div style="flex: 1; min-width: 300px; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;">
                                <h4>Balanced Diet Impact on Cognitive Performance</h4>
                                <p style="color: var(--subtle-text); font-size: 0.9rem;">Published: September 10, 2025</p>
                                <p>Our analysis of 5,000+ participants shows a strong correlation between Mediterranean-style diets and improved cognitive test scores across all age groups.</p>
                            </div>
                            
                            <div style="flex: 1; min-width: 300px; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;">
                                <h4>Hydration and Physical Performance Metrics</h4>
                                <p style="color: var(--subtle-text); font-size: 0.9rem;">Published: August 22, 2025</p>
                                <p>Data from professional athletes demonstrates optimal hydration levels can improve endurance by up to 15% during high-intensity activities.</p>
                            </div>
                            
                            <div style="flex: 1; min-width: 300px;">
                                <h4>Microbiome Diversity and Immune System Strength</h4>
                                <p style="color: var(--subtle-text); font-size: 0.9rem;">Published: July 30, 2025</p>
                                <p>Our machine learning models reveal that dietary fiber intake is the strongest predictor of healthy gut microbiome diversity.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <h3>Data Processing Tools</h3>
                        <p>Use our specialized data ingestion tools to analyze health and nutrition datasets:</p>
                        <ul style="margin-top: 1rem; padding-left: 1.5rem;">
                            <li>Nutritional content analysis</li>
                            <li>Dietary pattern recognition</li>
                            <li>Health outcome correlation studies</li>
                            <li>Longitudinal health data tracking</li>
                        </ul>
                        <p style="margin-top: 1rem;">Visit the <a href="#" onclick="switchView('data'); return false;" style="color: var(--primary-color);">Data tab</a> to upload and analyze your health datasets.</p>
                    </div>
                </div>
            </div>

            <!-- Contact Us Tab Content -->
            <div id="contact-view" class="view-content hidden">
                <div class="card">
                    <h2>Contact Us</h2>
                    <p>We'd love to hear from you. Reach out with any questions or feedback.</p>
                    
                    <div style="margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                        <div>
                            <h3>Get in Touch</h3>
                            <div style="margin-top: 1rem;">
                                <p><strong>Email:</strong> support@dataingest.com</p>
                                <p><strong>Phone:</strong> +1 (555) 123-4567</p>
                                <p><strong>Address:</strong> 123 Data Street, Tech City, TC 10001</p>
                            </div>
                            
                            <div style="margin-top: 2rem;">
                                <h4>Office Hours</h4>
                                <p>Monday - Friday: 9:00 AM - 6:00 PM EST</p>
                                <p>Saturday: 10:00 AM - 2:00 PM EST</p>
                            </div>
                        </div>
                        
                        <div>
                            <h3>Send us a Message</h3>
                            <form style="margin-top: 1rem;">
                                <div style="margin-bottom: 1rem;">
                                    <label for="contact-name" style="display: block; margin-bottom: 0.5rem;">Name</label>
                                    <input type="text" id="contact-name" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem;">
                                </div>
                                
                                <div style="margin-bottom: 1rem;">
                                    <label for="contact-email" style="display: block; margin-bottom: 0.5rem;">Email</label>
                                    <input type="email" id="contact-email" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem;">
                                </div>
                                
                                <div style="margin-bottom: 1rem;">
                                    <label for="contact-subject" style="display: block; margin-bottom: 0.5rem;">Subject</label>
                                    <input type="text" id="contact-subject" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem;">
                                </div>
                                
                                <div style="margin-bottom: 1rem;">
                                    <label for="contact-message" style="display: block; margin-bottom: 0.5rem;">Message</label>
                                    <textarea id="contact-message" rows="5" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem;"></textarea>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">Send Message</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore-compat.js"></script>

    <script type="module">
        // --- 0. FIREBASE SETUP ---
        // IMPORTANT: Replace this with your own Firebase project configuration!
        const firebaseConfig = {
            apiKey: "AIzaSyDPmfrpqGAp71ogoyb0nb_DzK5u2wusYrY",
            authDomain: "dataext1-c403d.firebaseapp.com",
            projectId: "dataext1-c403d",
            storageBucket: "dataext1-c403d.firebasestorage.app",
            messagingSenderId: "157022132435",
            appId: "1:157022132435:web:8eecb29c7f699ec6de1c26",
            measurementId: "G-PYHZ7SZ7T6"
        };

        // Initialize Firebase and Firestore
        let db;
        let isFirebaseInitialized = false;
        
        async function initializeFirebase() {
            try {
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK not loaded');
                }
                
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // Test the connection
                await db.enableNetwork();
                isFirebaseInitialized = true;
                console.log('Firebase initialized successfully');
                
                // Update status indicator
                if (firebaseStatus) {
                    firebaseStatus.style.backgroundColor = 'var(--success-color)';
                    firebaseStatus.innerHTML = '<span>Firebase: Connected</span>';
                }
                
            } catch (error) {
                console.error('Firebase initialization failed:', error);
                isFirebaseInitialized = false;
                
                // Update status indicator
                if (firebaseStatus) {
                    firebaseStatus.style.backgroundColor = 'var(--danger-color)';
                    firebaseStatus.innerHTML = '<span>Firebase: Error</span>';
                }
                
                showAlert(`<strong>Firebase Connection Failed:</strong><br>${error.message}<br><br>Please check your Firebase configuration and internet connection.`, 'danger');
            }
        }
        
        // Initialize Firebase when the page loads
        window.addEventListener('load', async () => {
            await initializeFirebase();
            
            // Auto-enable uploaded data tab if collections exist
            const uploadedCollections = JSON.parse(localStorage.getItem('uploadedCollections') || '[]');
            if (uploadedCollections.length > 0) {
                uploadedDataSubTabBtn.disabled = false;
            }
            
            // Set initial theme toggle state
            const root = document.documentElement;
            const currentBgColor = root.style.getPropertyValue('--background-color');
            if (currentBgColor === '#1e293b') {
                themeToggleCheckbox.checked = true;
            }
            
            // Show the home view by default
            switchView('home');
        });

        // --- 1. CONFIGURATION & INITIALIZATION ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const previewSection = document.getElementById('preview-section');
        const sheetTabsContainer = document.getElementById('sheet-tabs');
        const previewTable = document.getElementById('preview-table');
        const uploadBtn = document.getElementById('upload-btn');
        const btnText = document.getElementById('btn-text');
        const btnSpinner = document.getElementById('btn-spinner');
        const alertContainer = document.getElementById('alert-container');
        const targetTableContainer = document.getElementById('target-table-container');
        const targetTableNameEl = document.getElementById('target-table-name');
        
        // View & Tab elements
        const homeTabBtn = document.getElementById('home-tab-btn');
        const industryTabBtn = document.getElementById('industry-tab-btn');

        // Theme toggle element
        const themeToggle = document.getElementById('theme-toggle');
        const themeToggleCheckbox = document.getElementById('theme-toggle-checkbox');

        const newsTabBtn = document.getElementById('news-tab-btn');
        const dataTabBtn = document.getElementById('data-tab-btn');
        const regionalTabBtn = document.getElementById('regional-tab-btn');
        const eventsTabBtn = document.getElementById('events-tab-btn');
        const healthTabBtn = document.getElementById('health-tab-btn');
        const contactTabBtn = document.getElementById('contact-tab-btn');
        const aboutTabBtn = document.getElementById('about-tab-btn');
        
        // Data sub-tab elements
        const ingestSubTabBtn = document.getElementById('ingest-subtab-btn');
        const dashboardSubTabBtn = document.getElementById('dashboard-subtab-btn');
        const uploadedDataSubTabBtn = document.getElementById('uploaded-data-subtab-btn');
        const excelSubTabBtn = document.getElementById('excel-subtab-btn');
        
        // Data sub-view elements
        const dataView = document.getElementById('data-view');
        const ingestSubView = document.getElementById('ingest-subview');
        const dashboardSubView = document.getElementById('dashboard-subview');
        const uploadedDataSubView = document.getElementById('uploaded-data-subview');
        const excelSubView = document.getElementById('excel-subview');
        
        // About Us sub-tab elements
        const aboutUsSubTabBtn = document.getElementById('about-us-subtab-btn');
        const developerSubTabBtn = document.getElementById('developer-subtab-btn');
        const aboutMeSubTabBtn = document.getElementById('about-me-subtab-btn');
        
        // About Us sub-view elements
        const aboutUsSubView = document.getElementById('about-us-subview');
        const developerSubView = document.getElementById('developer-subview');
        const aboutMeSubView = document.getElementById('about-me-subview');

        const homeView = document.getElementById('home-view');
        const industryView = document.getElementById('industry-view');
        const newsView = document.getElementById('news-view');
        const regionalView = document.getElementById('regional-view');
        const eventsView = document.getElementById('events-view');
        const healthView = document.getElementById('health-view');
        const contactView = document.getElementById('contact-view');
        const aboutView = document.getElementById('about-view');

        // Firebase Data Viewer elements
        const collectionSelector = document.getElementById('collection-selector');
        const refreshCollectionsBtn = document.getElementById('refresh-collections-btn');
        const toggleEmptyCellsBtn = document.getElementById('toggle-empty-cells-btn');
        const firebaseStatus = document.getElementById('firebase-status');
        const collectionStats = document.getElementById('collection-stats');
        const totalDocumentsStat = document.getElementById('total-documents-stat');
        const collectionNameStat = document.getElementById('collection-name-stat');
        const lastUpdatedStat = document.getElementById('last-updated-stat');
        const firebaseDataContainer = document.getElementById('firebase-data-container');
        const firebaseDataLoading = document.getElementById('firebase-data-loading');
        const firebaseDataTableContainer = document.getElementById('firebase-data-table-container');
        const firebaseDataTable = document.getElementById('firebase-data-table');
        const firebaseDataPagination = document.getElementById('firebase-data-pagination');
        const noFirebaseData = document.getElementById('no-firebase-data');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const pageInfo = document.getElementById('page-info');

        // Firebase data viewer state
        let currentCollection = '';
        let currentPage = 1;
        const pageSize = 50;
        let totalDocuments = 0;
        let lastDocument = null;
        let showEmptyCells = false;
        let currentDocuments = [];

        // Dashboard elements
        const totalSheetsStat = document.getElementById('total-sheets-stat');
        const totalRowsStat = document.getElementById('total-rows-stat');
        const totalColsStat = document.getElementById('total-cols-stat');
        const rowsPieChartCtx = document.getElementById('rows-pie-chart').getContext('2d');
        const typesPieChartCtx = document.getElementById('types-pie-chart').getContext('2d');
        let rowsPieChart = null, typesPieChart = null;

        // Column Analysis elements
        const columnAnalysisSection = document.getElementById('column-analysis-section');
        const sheetSelector = document.getElementById('sheet-selector');
        const columnSelector = document.getElementById('column-selector');
        const analysisResults = document.getElementById('analysis-results');
        const analysisStatsGrid = document.getElementById('analysis-stats-grid');
        const analysisChartCtx = document.getElementById('analysis-chart').getContext('2d');
        const analysisPlaceholder = document.getElementById('analysis-placeholder');
        let analysisChart = null;

        let sheetsData = {};
        let sheetsMetadata = {};
        let currentSheetName = '';

        const SUPPORTED_TYPES = [
            { label: 'Text', value: 'text' }, { label: 'Integer', value: 'integer' },
            { label: 'Numeric', value: 'numeric' }, { label: 'Boolean', value: 'boolean' },
            { label: 'Date', value: 'date' }, { label: 'Timestamp', value: 'timestamptz' },
        ];
        
        const DROP_ZONE_DEFAULT_HTML = `<svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 19.5H5.25A2.25 2.25 0 013 17.25z" /></svg><p>Drag & drop your file here, or <strong>click to upload</strong>.</p><small class="subtle-text">Supported formats: .xlsx, .csv, .xlsm</small>`;


        // --- 2. EVENT LISTENERS ---
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault(); dropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files; if (files.length) handleFile(files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            const files = e.target.files; if (files.length) handleFile(files[0]);
        });
        uploadBtn.addEventListener('click', uploadAllSheets);
        
        // Main tab event listeners
        homeTabBtn.addEventListener('click', () => switchView('home'));
        industryTabBtn.addEventListener('click', () => switchView('industry'));
        newsTabBtn.addEventListener('click', () => switchView('news'));
        dataTabBtn.addEventListener('click', () => switchView('data'));
        regionalTabBtn.addEventListener('click', () => switchView('regional'));
        eventsTabBtn.addEventListener('click', () => switchView('events'));
        healthTabBtn.addEventListener('click', () => switchView('health'));
        contactTabBtn.addEventListener('click', () => switchView('contact'));
        aboutTabBtn.addEventListener('click', () => switchView('about'));
        
        // Data sub-tab event listeners
        ingestSubTabBtn.addEventListener('click', () => switchDataSubView('ingest'));
        dashboardSubTabBtn.addEventListener('click', () => switchDataSubView('dashboard'));
        uploadedDataSubTabBtn.addEventListener('click', () => switchDataSubView('uploaded-data'));
        excelSubTabBtn.addEventListener('click', () => switchDataSubView('excel'));
        
        sheetSelector.addEventListener('change', updateColumnSelector);
        columnSelector.addEventListener('change', analyzeCurrentColumn);
        
        // Theme toggle event listener
        themeToggleCheckbox.addEventListener('change', toggleTheme);

        // Firebase data viewer event listeners
        refreshCollectionsBtn.addEventListener('click', refreshCollections);

        // About Us sub-tab event listeners
        aboutUsSubTabBtn.addEventListener('click', () => switchAboutUsSubView('about-us'));
        developerSubTabBtn.addEventListener('click', () => switchAboutUsSubView('developer'));
        aboutMeSubTabBtn.addEventListener('click', () => switchAboutUsSubView('about-me'));

        // Excel tab elements
        const excelDropZone = document.getElementById('excel-drop-zone');
        const excelFileInput = document.getElementById('excel-file-input');
        const excelPreviewSection = document.getElementById('excel-preview-section');
        const excelPreviewTable = document.getElementById('excel-preview-table');
        const excelProcessBtn = document.getElementById('excel-process-btn');

        // Excel tab event listeners
        if (excelDropZone && excelFileInput) {
            excelDropZone.addEventListener('click', () => excelFileInput.click());
            excelDropZone.addEventListener('dragover', (e) => { 
                e.preventDefault(); 
                excelDropZone.classList.add('drag-over'); 
            });
            excelDropZone.addEventListener('dragleave', () => excelDropZone.classList.remove('drag-over'));
            excelDropZone.addEventListener('drop', (e) => {
                e.preventDefault(); 
                excelDropZone.classList.remove('drag-over');
                const files = e.dataTransfer.files; 
                if (files.length) handleExcelFile(files[0]);
            });
            excelFileInput.addEventListener('change', (e) => {
                const files = e.target.files; 
                if (files.length) handleExcelFile(files[0]);
            });
        }

        if (excelProcessBtn) {
            excelProcessBtn.addEventListener('click', processExcelData);
        }

        collectionSelector.addEventListener('change', loadCollectionData);
        prevPageBtn.addEventListener('click', () => changePage(-1));
        nextPageBtn.addEventListener('click', () => changePage(1));
        toggleEmptyCellsBtn.addEventListener('click', toggleEmptyCells);

        // Header truncation function
        function truncateHeader(headerText, maxLength = 20) {
            if (!headerText || headerText.length <= maxLength) {
                return headerText;
            }
            
            // Try to break at logical points first
            const parts = headerText.split('_');
            if (parts.length > 1) {
                // Try to create a meaningful abbreviation
                let abbreviated = '';
                let currentLength = 0;
                
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    if (i === 0) {
                        // Always include the first part (but may truncate if too long)
                        if (part.length > maxLength - 5) {
                            abbreviated = part.substring(0, maxLength - 5) + '...';
                            currentLength = maxLength - 2;
                        } else {
                            abbreviated = part;
                            currentLength = part.length;
                        }
                    } else if (currentLength + part.length + 1 <= maxLength) {
                        // Add part if it fits
                        abbreviated += '_' + part;
                        currentLength += part.length + 1;
                    } else {
                        // Take first letter of remaining parts
                        const firstLetter = part.charAt(0).toUpperCase();
                        if (currentLength + firstLetter.length + 1 <= maxLength - 2) {
                            abbreviated += '_' + firstLetter;
                            currentLength += 2;
                        } else {
                            // Add "..." if there are more parts
                            if (i < parts.length - 1 && currentLength + 3 <= maxLength) {
                                abbreviated += '...';
                            }
                            break;
                        }
                    }
                }
                
                if (abbreviated.length < headerText.length) {
                    return abbreviated;
                }
            }
            
            // Fallback: smart truncation at word boundaries
            if (headerText.length > maxLength) {
                // Try to break at camelCase or underscores
                const breakPoints = [];
                for (let i = 1; i < headerText.length - 3; i++) {
                    if (headerText[i] === '_' || 
                        (headerText[i].toUpperCase() === headerText[i] && headerText[i-1].toLowerCase() === headerText[i-1])) {
                        breakPoints.push(i);
                    }
                }
                
                // Find the best break point
                const idealLength = maxLength - 3;
                let bestBreak = -1;
                for (const bp of breakPoints) {
                    if (bp <= idealLength && (bestBreak === -1 || bp > bestBreak)) {
                        bestBreak = bp;
                    }
                }
                
                if (bestBreak > 5) { // Only break if we get a reasonable amount
                    return headerText.substring(0, bestBreak) + '...';
                }
            }
            
            // Final fallback: simple truncation
            return headerText.substring(0, maxLength - 3) + '...';
        }
        
        function formatHeaderForDisplay(headerText, fullText = null) {
            const originalText = fullText || headerText;
            const truncatedText = truncateHeader(headerText);
            
            if (truncatedText === headerText) {
                return headerText; // No truncation needed
            }
            
            return `<span class="truncated-header" title="${originalText}">${truncatedText}</span>`;
        }
        
        // Enhanced data cleaning functions
        function removeDuplicateRows(data) {
            if (!data || data.length === 0) return [];
            
            const seen = new Set();
            const uniqueRows = [];
            
            data.forEach(row => {
                // Create a hash of the row content (excluding any auto-generated IDs)
                const rowContent = {};
                Object.keys(row).forEach(key => {
                    if (key !== 'id' && !isEmpty(row[key])) {
                        rowContent[key] = row[key];
                    }
                });
                
                const rowHash = JSON.stringify(rowContent, Object.keys(rowContent).sort());
                
                if (!seen.has(rowHash)) {
                    seen.add(rowHash);
                    uniqueRows.push(row);
                }
            });
            
            return uniqueRows;
        }
        
        function performAdvancedDataCleaning(data, options = {}) {
            if (!data || data.length === 0) return [];
            
            const {
                removeEmptyRows = true,
                removeEmptyColumns = true,
                removeEmptyCells = true,
                trimWhitespace = true,
                removeDuplicates = true,
                minNonEmptyColumns = 1,
                minNonEmptyRows = 1
            } = options;
            
            let cleanedData = [...data];
            
            // Step 1: Clean individual cells
            if (removeEmptyCells || trimWhitespace) {
                cleanedData = cleanedData.map(row => {
                    const cleanedRow = {};
                    for (const [key, value] of Object.entries(row)) {
                        let cleanedValue = value;
                        
                        if (trimWhitespace && typeof cleanedValue === 'string') {
                            cleanedValue = cleanedValue.trim();
                        }
                        
                        // Only include non-empty values
                        if (!isEmpty(cleanedValue)) {
                            cleanedRow[key] = cleanedValue;
                        }
                    }
                    return cleanedRow;
                });
            }
            
            // Step 2: Remove empty rows - more aggressive approach
            if (removeEmptyRows) {
                cleanedData = cleanedData.filter(row => {
                    // First check: completely empty rows
                    if (isRowEmpty(row, 1)) return false;
                    
                    // Second check: mostly empty rows (70% empty)
                    if (isRowMostlyEmpty(row, 0.7)) return false;
                    
                    // Third check: minimum meaningful content
                    const nonEmptyValues = Object.values(row).filter(val => !isEmpty(val));
                    return nonEmptyValues.length >= minNonEmptyColumns;
                });
            }
            
            // Step 3: Remove empty columns
            if (removeEmptyColumns && cleanedData.length > 0) {
                const allColumns = Object.keys(cleanedData[0] || {});
                const nonEmptyColumns = allColumns.filter(column => {
                    const nonEmptyValues = cleanedData.filter(row => !isEmpty(row[column]));
                    return nonEmptyValues.length >= minNonEmptyRows;
                });
                
                cleanedData = cleanedData.map(row => {
                    const cleanedRow = {};
                    nonEmptyColumns.forEach(column => {
                        if (row.hasOwnProperty(column)) {
                            cleanedRow[column] = row[column];
                        }
                    });
                    return cleanedRow;
                });
            }
            
            // Step 4: Remove duplicate rows
            if (removeDuplicates) {
                const originalLength = cleanedData.length;
                cleanedData = removeDuplicateRows(cleanedData);
                const duplicatesRemoved = originalLength - cleanedData.length;
                if (duplicatesRemoved > 0) {
                    console.log(`Removed ${duplicatesRemoved} duplicate rows`);
                }
            }
            
            return cleanedData;
        }
        
        function isEmpty(value) {
            if (value === null || value === undefined) return true;
            if (typeof value === 'string') {
                const trimmed = value.trim();
                return trimmed === '' || trimmed === 'null' || trimmed === 'undefined' || trimmed === 'N/A' || trimmed === '-' || trimmed === '0' || trimmed === 'NULL' || trimmed === 'n/a';
            }
            if (typeof value === 'number') return isNaN(value) || value === 0;
            if (Array.isArray(value)) return value.length === 0;
            if (typeof value === 'object') return Object.keys(value).length === 0;
            return false;
        }
        
        function isRowEmpty(row, minimumFields = 1) {
            if (!row || typeof row !== 'object') return true;
            
            const nonEmptyValues = Object.values(row).filter(val => !isEmpty(val));
            return nonEmptyValues.length < minimumFields;
        }
        
        function isRowMostlyEmpty(row, threshold = 0.7) {
            if (!row || typeof row !== 'object') return true;
            
            const totalFields = Object.keys(row).length;
            if (totalFields === 0) return true;
            
            const emptyFields = Object.values(row).filter(val => isEmpty(val)).length;
            const emptyRatio = emptyFields / totalFields;
            
            return emptyRatio >= threshold;
        }
        
        function getDataCleaningStats(originalData, cleanedData) {
            const originalRows = originalData.length;
            const cleanedRows = cleanedData.length;
            const originalColumns = originalData.length > 0 ? Object.keys(originalData[0]).length : 0;
            const cleanedColumns = cleanedData.length > 0 ? Object.keys(cleanedData[0]).length : 0;
            
            // Count empty rows in original data
            const emptyRowsCount = originalData.filter(row => isRowEmpty(row, 1) || isRowMostlyEmpty(row, 0.7)).length;
            const meaningfulRowsRemoved = (originalRows - cleanedRows) - emptyRowsCount;
            
            return {
                originalRows,
                cleanedRows,
                removedRows: originalRows - cleanedRows,
                emptyRowsRemoved: emptyRowsCount,
                meaningfulRowsRemoved: Math.max(0, meaningfulRowsRemoved),
                originalColumns,
                cleanedColumns,
                removedColumns: originalColumns - cleanedColumns,
                rowsRemovalPercentage: originalRows > 0 ? ((originalRows - cleanedRows) / originalRows * 100).toFixed(1) : 0,
                columnsRemovalPercentage: originalColumns > 0 ? ((originalColumns - cleanedColumns) / originalColumns * 100).toFixed(1) : 0
            };
        }
        function detectAndCleanHeaders(jsonData) {
            if (!jsonData || jsonData.length === 0) return [];
            
            // Get all possible header rows (first 5 rows to check for headers)
            const headerCandidates = jsonData.slice(0, Math.min(5, jsonData.length));
            let bestHeaderRow = null;
            let bestScore = -1;
            let bestRowIndex = 0;
            
            // Score each row as a potential header
            headerCandidates.forEach((row, index) => {
                const score = scoreAsHeader(row);
                if (score > bestScore) {
                    bestScore = score;
                    bestHeaderRow = row;
                    bestRowIndex = index;
                }
            });
            
            // If we found a good header row that's not the first row, use it
            if (bestHeaderRow && bestRowIndex > 0 && bestScore > 0.5) {
                return {
                    headers: Object.keys(bestHeaderRow),
                    dataStartIndex: bestRowIndex,
                    cleanedData: jsonData.slice(bestRowIndex)
                };
            }
            
            // Otherwise, clean the existing headers
            const originalHeaders = Object.keys(jsonData[0] || {});
            const cleanedHeaders = originalHeaders.map(header => cleanHeaderName(header));
            
            return {
                headers: cleanedHeaders,
                dataStartIndex: 0,
                cleanedData: jsonData,
                headerMapping: originalHeaders.reduce((map, original, index) => {
                    map[original] = cleanedHeaders[index];
                    return map;
                }, {})
            };
        }
        
        function scoreAsHeader(row) {
            const values = Object.values(row);
            let score = 0;
            let totalValues = 0;
            
            values.forEach(value => {
                if (value !== null && value !== undefined && String(value).trim() !== '') {
                    totalValues++;
                    const str = String(value).trim();
                    
                    // Higher score for text that looks like headers
                    if (isLikelyHeaderText(str)) score += 2;
                    // Lower score for numbers (less likely to be headers)
                    else if (isNumeric(str)) score -= 1;
                    // Medium score for mixed content
                    else score += 0.5;
                }
            });
            
            // Normalize score by number of non-empty values
            return totalValues > 0 ? score / totalValues : 0;
        }
        
        function isLikelyHeaderText(str) {
            // Common header patterns
            const headerPatterns = [
                /^(name|title|description|date|time|target|incident|status|type|category|id|code)$/i,
                /^(first|last|full).?(name)$/i,
                /^(start|end|created|updated|modified).?(date|time)$/i,
                /^(phone|email|address|location|city|state|country)$/i,
                /^(amount|price|cost|value|quantity|count|number|total)$/i,
                /^(department|company|organization|team|group)$/i,
                /^(priority|severity|urgency|level|grade|score)$/i
            ];
            
            // Check against patterns
            if (headerPatterns.some(pattern => pattern.test(str))) return true;
            
            // Check for general header characteristics
            if (str.length > 1 && str.length < 50) {
                // Contains mostly letters and common separators
                if (/^[a-zA-Z][a-zA-Z0-9\s_\-\.]+$/i.test(str)) return true;
                // Title case or all caps (likely headers)
                if (/^[A-Z][a-z]+(?:\s[A-Z][a-z]+)*$/.test(str) || /^[A-Z\s_]+$/.test(str)) return true;
            }
            
            return false;
        }
        
        function isNumeric(str) {
            return !isNaN(parseFloat(str)) && isFinite(str);
        }
        
        function cleanHeaderName(header) {
            if (!header || typeof header !== 'string') {
                return 'Unnamed_Column';
            }
            
            let cleaned = String(header).trim();
            
            // If empty or just whitespace
            if (!cleaned || /^\s*$/.test(cleaned)) {
                return 'Unnamed_Column';
            }
            
            // If it's just numbers or generic patterns, try to make it meaningful
            if (/^\d+$/.test(cleaned)) {
                return `Column_${cleaned}`;
            }
            
            // If it's a generic Excel column name like "__EMPTY", "Column1", etc.
            if (/^(__EMPTY|Column\d+|Field\d+)$/i.test(cleaned)) {
                return 'Unnamed_Column';
            }
            
            // Clean up common issues
            cleaned = cleaned
                .replace(/^[\s\-_]+|[\s\-_]+$/g, '') // Remove leading/trailing spaces, dashes, underscores
                .replace(/\s+/g, '_') // Replace spaces with underscores
                .replace(/[^a-zA-Z0-9_\-]/g, '_') // Replace special characters with underscores
                .replace(/_+/g, '_') // Collapse multiple underscores
                .replace(/^_+|_+$/g, ''); // Remove leading/trailing underscores
            
            // If after cleaning it's empty, provide a default
            if (!cleaned) {
                return 'Unnamed_Column';
            }
            
            // Ensure it doesn't start with a number
            if (/^\d/.test(cleaned)) {
                cleaned = `Col_${cleaned}`;
            }
            
            // Convert to proper case for better readability
            cleaned = cleaned.split('_').map(word => {
                if (word.length === 0) return word;
                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            }).join('_');
            
            return cleaned;
        }
        
        function generateMeaningfulHeaders(data, originalHeaders) {
            const meaningfulHeaders = [];
            
            originalHeaders.forEach((header, index) => {
                // If header is meaningful, use cleaned version
                if (header && !(/^(__EMPTY|Column\d+|Field\d+|\s*|\d+)$/i.test(String(header).trim()))) {
                    meaningfulHeaders.push(cleanHeaderName(header));
                } else {
                    // Try to infer meaning from data
                    const columnData = data.slice(0, 10).map(row => Object.values(row)[index]).filter(val => val != null);
                    const inferredName = inferColumnName(columnData, index);
                    meaningfulHeaders.push(inferredName);
                }
            });
            
            // Ensure uniqueness
            return ensureUniqueHeaders(meaningfulHeaders);
        }
        
        function inferColumnName(columnData, index) {
            if (!columnData || columnData.length === 0) {
                return `Column_${index + 1}`;
            }
            
            // Sample first few non-null values
            const samples = columnData.slice(0, 5).map(val => String(val).trim());
            
            // Check for common patterns
            const patterns = [
                { pattern: /^\d{4}-\d{2}-\d{2}/, name: 'Date' },
                { pattern: /^\d{1,2}\/\d{1,2}\/\d{4}/, name: 'Date' },
                { pattern: /^[a-zA-Z]+@[a-zA-Z]+\.[a-zA-Z]+/, name: 'Email' },
                { pattern: /^\+?[\d\s\-\(\)]+$/, name: 'Phone' },
                { pattern: /^\$?[\d,]+\.\d{2}$/, name: 'Amount' },
                { pattern: /^\d+$/, name: 'Number' },
                { pattern: /^(true|false|yes|no|y|n)$/i, name: 'Boolean' },
                { pattern: /^[A-Z]{2,}$/, name: 'Code' },
                { pattern: /^\d+%$/, name: 'Percentage' }
            ];
            
            // Check each pattern
            for (const { pattern, name } of patterns) {
                if (samples.some(sample => pattern.test(sample))) {
                    return name;
                }
            }
            
            // Check for name-like patterns
            const namePatterns = [
                /^[A-Z][a-z]+\s[A-Z][a-z]+$/,  // First Last
                /^[A-Z][a-z]+$/,               // Single name
                /^[A-Z]+$/                     // All caps (could be last name)
            ];
            
            if (samples.some(sample => namePatterns.some(pattern => pattern.test(sample)))) {
                return 'Name';
            }
            
            // If all else fails, use a descriptive generic name
            const hasText = samples.some(sample => /[a-zA-Z]/.test(sample));
            const hasNumbers = samples.some(sample => /\d/.test(sample));
            
            if (hasText && !hasNumbers) return 'Text_Field';
            if (hasNumbers && !hasText) return 'Numeric_Field';
            if (hasText && hasNumbers) return 'Mixed_Field';
            
            return `Column_${index + 1}`;
        }
        
        function ensureUniqueHeaders(headers) {
            const seen = new Set();
            const unique = [];
            
            headers.forEach(header => {
                let uniqueHeader = header;
                let counter = 1;
                
                while (seen.has(uniqueHeader)) {
                    uniqueHeader = `${header}_${counter}`;
                    counter++;
                }
                
                seen.add(uniqueHeader);
                unique.push(uniqueHeader);
            });
            
            return unique;
        }
        
        function showFileError(message, fileName = '') {
            const finalMessage = fileName ? message.replace(/\$\{fileName\}/g, `<strong>"${fileName}"</strong>`) : message;
            showAlert(finalMessage, 'danger');
            dropZone.classList.add('error');
            dropZone.innerHTML = DROP_ZONE_DEFAULT_HTML;
            fileInput.value = '';
        }

        function handleFile(file) {
            resetUI();
            
            // File size validation (10MB limit)
            const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB in bytes
            if (file.size > MAX_FILE_SIZE) {
                showFileError(`<strong>File Too Large:</strong><br>File \${fileName} is ${(file.size / (1024 * 1024)).toFixed(1)}MB. Maximum allowed size is 10MB.`, file.name);
                return;
            }
            
            const spinnerHTML = `<div class="spinner" style="width: 32px; height: 32px; border-width: 4px; border-top-color: var(--primary-color); border-right-color: transparent; border-bottom-color: transparent; border-left-color: transparent;"></div>`;
            dropZone.innerHTML = `<div style="display: flex; flex-direction: column; align-items: center; gap: 1rem; color: var(--subtle-text);">
                                    ${spinnerHTML}
                                    <p>Processing <strong>${file.name}</strong>...</p>
                                  </div>`;

            const extension = file.name.split('.').pop().toLowerCase();
            
            setTimeout(() => {
                if (!['xlsx', 'csv', 'xlsm'].includes(extension)) {
                    showFileError(`<strong>Unsupported File Type:</strong><br>File \${fileName} is not a supported format. Please upload a .xlsx, .csv, or .xlsm file.`, file.name);
                    return;
                }

                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                            showFileError(`<strong>Invalid File:</strong><br>The file \${fileName} appears to be empty or does not contain any sheets.`, file.name);
                            return;
                        }
                        
                        sheetsData = {};
                        const fileNameWithoutExt = file.name.substring(0, file.name.lastIndexOf('.')) || file.name;
                        
                        workbook.SheetNames.forEach(sheetName => {
                            const worksheet = workbook.Sheets[sheetName];
                            const rawJsonData = XLSX.utils.sheet_to_json(worksheet, { defval: null });

                            if (rawJsonData.length === 0) return;

                            // Detect and clean headers
                            const headerResult = detectAndCleanHeaders(rawJsonData);
                            let { headers, dataStartIndex, cleanedData, headerMapping } = headerResult;
                            
                            // If no meaningful headers found, generate them
                            if (!headers || headers.every(h => h === 'Unnamed_Column' || !h)) {
                                const originalHeaders = Object.keys(rawJsonData[0] || {});
                                headers = generateMeaningfulHeaders(rawJsonData, originalHeaders);
                                headerMapping = originalHeaders.reduce((map, original, index) => {
                                    map[original] = headers[index];
                                    return map;
                                }, {});
                            }

                            // Process the data with new headers
                            const processedData = cleanedData.map(row => {
                                const newRow = {};
                                Object.keys(row).forEach((originalKey, index) => {
                                    const newKey = headerMapping ? headerMapping[originalKey] : headers[index] || cleanHeaderName(originalKey);
                                    const value = row[originalKey];
                                    if (value !== null && value !== undefined && String(value).trim() !== '') {
                                        newRow[newKey] = value;
                                    }
                                });
                                return newRow;
                            });

                            // Apply advanced data cleaning
                            const originalDataForStats = [...processedData];
                            const finalCleanedData = performAdvancedDataCleaning(processedData, {
                                removeEmptyRows: true,
                                removeEmptyColumns: true,
                                removeEmptyCells: true,
                                trimWhitespace: true,
                                removeDuplicates: true,
                                minNonEmptyColumns: 2, // Require at least 2 meaningful fields per row
                                minNonEmptyRows: 1 // Keep columns with at least 1 non-empty row
                            });
                            
                            // Get cleaning stats
                            const cleaningStats = getDataCleaningStats(originalDataForStats, finalCleanedData);
                            
                            if (finalCleanedData.length > 0 && Object.keys(finalCleanedData[0]).length > 0) {
                                const effectiveSheetName = extension === 'csv' ? fileNameWithoutExt : sheetName;
                                sheetsData[effectiveSheetName] = finalCleanedData;
                                
                                // Store cleaning stats for later display
                                if (!window.cleaningStats) window.cleaningStats = {};
                                window.cleaningStats[effectiveSheetName] = cleaningStats;
                            }
                        });
                        processParsedData(); 

                    } catch (error) {
                        console.error(`Error parsing ${file.name}:`, error);
                        showFileError(`<strong>Error Parsing File:</strong><br>Could not read \${fileName}. The file may be corrupted, password-protected, or in an unsupported format.`, file.name);
                    }
                };

                reader.onerror = () => {
                    console.error(`Error reading file ${file.name}`);
                    showFileError(`<strong>File Read Error:</strong><br>An error occurred while trying to read \${fileName}. Please ensure it is not damaged or locked.`, file.name);
                };

                reader.readAsArrayBuffer(file);
            }, 50);
        }

        function processParsedData() {
            const dataSheetNames = Object.keys(sheetsData);
            if (dataSheetNames.length === 0) {
                showFileError('<strong>No Data Found:</strong><br>The uploaded file does not contain any data rows after cleaning empty rows and columns.');
                return;
            }

            // Check if headers were improved
            let headersImproved = false;
            dataSheetNames.forEach(sheetName => {
                const data = sheetsData[sheetName];
                if (data && data.length > 0) {
                    const headers = Object.keys(data[0]);
                    // Check if any headers look like they were generated/cleaned
                    if (headers.some(h => /^(Column_\d+|Text_Field|Numeric_Field|Mixed_Field|Name|Date|Email|Phone|Amount|Boolean|Code|Percentage)/.test(h))) {
                        headersImproved = true;
                    }
                }
            });

            initializeMetadata(sheetsData);
            renderDashboardOverview(sheetsData, sheetsMetadata);
            initializeColumnAnalysis();

            currentSheetName = dataSheetNames[0];
            renderSheetTabs(dataSheetNames);
            renderPreviewTable(sheetsData[currentSheetName]);
            updateTargetTableInfo(currentSheetName);
            
            // Show header improvement notification if applicable
            const headerInfo = document.getElementById('header-info');
            if (headersImproved && headerInfo) {
                headerInfo.classList.remove('hidden');
            }
            
            // Show data cleaning stats if available
            if (window.cleaningStats) {
                let totalRemovedRows = 0;
                let totalRemovedColumns = 0;
                Object.values(window.cleaningStats).forEach(stats => {
                    totalRemovedRows += stats.removedRows;
                    totalRemovedColumns += stats.removedColumns;
                });
                
                if (totalRemovedRows > 0 || totalRemovedColumns > 0) {
                    let detailedStats = [];
                    let totalEmptyRows = 0;
                    let totalMeaningfulRows = 0;
                    
                    Object.values(window.cleaningStats).forEach(stats => {
                        totalEmptyRows += stats.emptyRowsRemoved || 0;
                        totalMeaningfulRows += stats.meaningfulRowsRemoved || 0;
                    });
                    
                    if (totalEmptyRows > 0) {
                        detailedStats.push(`${totalEmptyRows} empty rows`);
                    }
                    if (totalMeaningfulRows > 0) {
                        detailedStats.push(`${totalMeaningfulRows} sparse rows`);
                    }
                    if (totalRemovedColumns > 0) {
                        detailedStats.push(`${totalRemovedColumns} empty columns`);
                    }
                    
                    const cleaningInfo = document.createElement('div');
                    cleaningInfo.className = 'alert alert-info';
                    cleaningInfo.style.marginBottom = '1rem';
                    cleaningInfo.innerHTML = `<strong>Data Cleaned:</strong> Removed ${detailedStats.join(', ')} for better data quality.`;
                    
                    const previewSection = document.getElementById('preview-section');
                    const existingAlert = previewSection.querySelector('.alert');
                    if (existingAlert) {
                        existingAlert.parentNode.insertBefore(cleaningInfo, existingAlert.nextSibling);
                    } else {
                        previewSection.insertBefore(cleaningInfo, previewSection.children[1]);
                    }
                }
            }
            
            previewSection.classList.remove('hidden');
            uploadBtn.disabled = false;
            dashboardSubTabBtn.disabled = false;
            switchDataSubView('ingest');
        }

        function renderSheetTabs(sheetNames) {
            sheetTabsContainer.innerHTML = '';
            sheetNames.forEach(name => {
                const tabBtn = document.createElement('button');
                tabBtn.className = 'sheet-tab';
                const displayName = truncateHeader(name, 15); // Shorter for tabs
                tabBtn.textContent = displayName;
                tabBtn.title = name; // Full name on hover
                if (name === currentSheetName) tabBtn.classList.add('active');
                tabBtn.addEventListener('click', () => switchSheet(name));
                sheetTabsContainer.appendChild(tabBtn);
            });
        }

        function switchSheet(sheetName) {
            if (sheetName === currentSheetName) return;
            currentSheetName = sheetName;
            renderPreviewTable(sheetsData[currentSheetName]);
            updateTargetTableInfo(sheetName);
            document.querySelectorAll('.sheet-tab').forEach(tab => {
                tab.classList.toggle('active', tab.textContent === sheetName);
            });
        }

        function renderPreviewTable(data) {
            if (!data || data.length === 0) {
                previewTable.innerHTML = '<thead><tr><th>No data to display.</th></tr></thead>'; return;
            }
            
            // Apply the same cleaning logic as the Firebase viewer
            const allHeaders = Object.keys(data[0]);
            
            // Filter out columns that are mostly empty
            const meaningfulHeaders = allHeaders.filter(header => {
                const nonEmptyCount = data.filter(row => !isEmpty(row[header])).length;
                const threshold = Math.max(1, Math.floor(data.length * 0.1));
                return nonEmptyCount >= threshold;
            });
            
            const headers = meaningfulHeaders.length > 0 ? meaningfulHeaders : allHeaders;
            
            // Filter out empty or mostly empty rows for preview
            const meaningfulRows = data.filter(row => {
                if (isRowEmpty(row, 1)) return false;
                if (isRowMostlyEmpty(row, 0.8)) return false; // More lenient for preview
                return true;
            });
            
            const thead = `<thead><tr>${headers.map(h => `<th>${formatHeaderForDisplay(h)}</th>`).join('')}</tr></thead>`;
            
            const tbody = `<tbody>${meaningfulRows.slice(0, 100).map(row => 
                `<tr>${headers.map(h => {
                    const value = row[h];
                    let displayValue = '';
                    if (!isEmpty(value)) {
                        displayValue = String(value);
                        // Truncate long values in preview
                        if (displayValue.length > 50) {
                            displayValue = displayValue.substring(0, 50) + '...';
                        }
                    }
                    return `<td title="${displayValue}">${displayValue}</td>`;
                }).join('')}</tr>`
            ).join('')}</tbody>`;
            
            previewTable.innerHTML = thead + tbody;
        }

        async function uploadAllSheets() {
            if (!isFirebaseInitialized || !db) {
                showAlert('Firestore is not initialized. Please check your Firebase configuration and ensure you have an internet connection.', 'danger');
                return;
            }

            const sheetNames = Object.keys(sheetsData);
            if (sheetNames.length === 0) {
                showAlert('No data available to upload.', 'danger'); return;
            }

            // Check internet connectivity
            if (!navigator.onLine) {
                showAlert('No internet connection. Please check your network and try again.', 'danger');
                return;
            }

            setLoadingState(true);
            alertContainer.innerHTML = '';
            const logContainer = document.createElement('div');
            logContainer.className = 'alert alert-info show'; logContainer.style.maxHeight = '300px';
            logContainer.style.overflowY = 'auto';
            alertContainer.appendChild(logContainer);
            const log = (message) => { logContainer.innerHTML += message + '<br>'; logContainer.scrollTop = logContainer.scrollHeight; };
            log(`<strong>Starting upload for ${sheetNames.length} sheet(s) to Firestore...</strong>`);
            let successCount = 0, errorCount = 0;
            let totalRecords = sheetNames.reduce((sum, name) => sum + sheetsData[name].length, 0);
            let processedRecords = 0;

            for (const sheetName of sheetNames) {
                const dataToUpload = sheetsData[sheetName];
                const collectionName = sanitizeForFirestore(sheetName);
                const metadata = sheetsMetadata[sheetName];
                log(`Sheet '${sheetName}' ➔ Collection '${collectionName}': Preparing ${dataToUpload.length} records...`);

                try {
                    const sanitizedData = dataToUpload.map(row => {
                        const newRow = {};
                        metadata.columns.forEach(col => {
                           if (col.sanitizedName) {
                               const value = row[col.name];
                               newRow[col.sanitizedName] = (value === undefined || value === null) ? null : value;
                           }
                        });
                        return newRow;
                    });

                    // Firestore batch writes are limited to 500 operations.
                    const BATCH_SIZE = 500;
                    for (let i = 0; i < sanitizedData.length; i += BATCH_SIZE) {
                        const batch = db.batch();
                        const chunk = sanitizedData.slice(i, i + BATCH_SIZE);
                        
                        log(`Uploading batch ${Math.floor(i / BATCH_SIZE) + 1}... (${chunk.length} records)`);
                        
                        chunk.forEach(rowData => {
                            const docRef = db.collection(collectionName).doc(); // Auto-generate document ID
                            batch.set(docRef, rowData);
                        });
                        
                        // Add timeout and retry logic
                        let retries = 3;
                        while (retries > 0) {
                            try {
                                await batch.commit();
                                processedRecords += chunk.length;
                                const progress = Math.round((processedRecords / totalRecords) * 100);
                                log(`Progress: ${progress}% (${processedRecords}/${totalRecords} records)`);
                                break;
                            } catch (batchError) {
                                retries--;
                                if (retries === 0) throw batchError;
                                log(`Batch failed, retrying... (${retries} attempts left)`);
                                await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second before retry
                            }
                        }
                    }
                    
                    log(`✅ Success: All ${dataToUpload.length} records for sheet '${sheetName}' uploaded to collection '${collectionName}'.`);
                    successCount++;
                } catch (error) {
                    console.error(`Error processing sheet ${sheetName}:`, error);
                    let errorMessage = error.message || 'An unexpected error occurred.';
                    
                    // Provide more specific error messages
                    if (error.code === 'permission-denied') {
                        errorMessage = 'Permission denied. Please check your Firestore security rules.';
                    } else if (error.code === 'unavailable') {
                        errorMessage = 'Service temporarily unavailable. Please try again later.';
                    } else if (error.message.includes('network')) {
                        errorMessage = 'Network error. Please check your internet connection.';
                    }
                    
                    log(`❌ Error on sheet '${sheetName}': ${errorMessage}`);
                    errorCount++;
                }
            }
            log(`<strong>Upload complete. Successful sheets: ${successCount}, Failed sheets: ${errorCount}.</strong>`);
            
            // Store successful collection names for later reference
            if (successCount > 0) {
                const uploadedCollections = JSON.parse(localStorage.getItem('uploadedCollections') || '[]');
                sheetNames.forEach(sheetName => {
                    const collectionName = sanitizeForFirestore(sheetName);
                    if (!uploadedCollections.includes(collectionName)) {
                        uploadedCollections.push(collectionName);
                    }
                });
                localStorage.setItem('uploadedCollections', JSON.stringify(uploadedCollections));
                
                // Enable uploaded data tab
                uploadedDataSubTabBtn.disabled = false;
                
                // Highlight the uploaded data tab briefly to draw attention
                uploadedDataSubTabBtn.style.backgroundColor = 'var(--success-color)';
                uploadedDataSubTabBtn.style.color = 'white';
                uploadedDataSubTabBtn.style.transform = 'scale(1.05)';
                
                // Auto-switch to uploaded data tab and show the uploaded data
                setTimeout(() => {
                    // Reset tab styling
                    uploadedDataSubTabBtn.style.backgroundColor = '';
                    uploadedDataSubTabBtn.style.color = '';
                    uploadedDataSubTabBtn.style.transform = '';
                    
                    switchDataSubView('uploaded-data');
                }, 1500); // Small delay to let the success message show
            }
            
            if (errorCount > 0) logContainer.classList.replace('alert-info', 'alert-danger');
            else logContainer.classList.replace('alert-info', 'alert-success');
            setLoadingState(false);
            if (errorCount === 0) resetUI(true);
        }
        
        // --- 4. DASHBOARD FUNCTIONS ---

        function renderDashboardOverview(sData, sMetadata) {
            const sheetNames = Object.keys(sData);
            const totalSheets = sheetNames.length;
            const totalRows = sheetNames.reduce((sum, name) => sum + sData[name].length, 0);
            const totalCols = sheetNames.reduce((sum, name) => sum + sMetadata[name].columns.length, 0);

            totalSheetsStat.textContent = totalSheets;
            totalRowsStat.textContent = totalRows.toLocaleString();
            totalColsStat.textContent = totalCols.toLocaleString();

            const chartColors = ['#4f46e5', '#10b981', '#f97316', '#8b5cf6', '#ec4899', '#f59e0b', '#34d399', '#6d28d9'];

            const rowsData = {
                labels: sheetNames,
                datasets: [{ data: sheetNames.map(name => sData[name].length), backgroundColor: chartColors, hoverOffset: 4 }]
            };
            if (rowsPieChart) rowsPieChart.destroy();
            rowsPieChart = new Chart(rowsPieChartCtx, { type: 'pie', data: rowsData, options: { responsive: true, plugins: { legend: { position: 'top', labels: { font: { size: 12 } } } } } });
            
            const typeCounts = {};
            Object.values(sMetadata).forEach(sheet => { sheet.columns.forEach(col => { typeCounts[col.userType] = (typeCounts[col.userType] || 0) + 1; }); });
            const typeLabels = Object.keys(typeCounts);
            const typesData = {
                labels: SUPPORTED_TYPES.filter(t => typeLabels.includes(t.value)).map(t => t.label),
                datasets: [{ data: SUPPORTED_TYPES.filter(t => typeLabels.includes(t.value)).map(t => typeCounts[t.value]), backgroundColor: chartColors, hoverOffset: 4 }]
            };
            if (typesPieChart) typesPieChart.destroy();
            typesPieChart = new Chart(typesPieChartCtx, { type: 'pie', data: typesData, options: { responsive: true, plugins: { legend: { position: 'top', labels: { font: { size: 12 } } } } } });
        }

        function initializeColumnAnalysis() {
            columnAnalysisSection.classList.remove('hidden');
            const sheetNames = Object.keys(sheetsData);
            sheetSelector.innerHTML = sheetNames.map(name => {
                const displayName = truncateHeader(name, 25);
                return `<option value="${name}" title="${name}">${displayName}</option>`;
            }).join('');
            if (sheetNames.length > 0) {
                sheetSelector.dispatchEvent(new Event('change'));
            }
        }
        
        function updateColumnSelector() {
            const selectedSheet = sheetSelector.value;
            const columns = sheetsMetadata[selectedSheet]?.columns || [];
            columnSelector.innerHTML = columns.map(col => {
                const displayName = truncateHeader(col.name, 25); // Slightly longer for dropdown
                return `<option value="${col.name}" title="${col.name}">${displayName}</option>`;
            }).join('');
            if (columns.length > 0) {
                columnSelector.dispatchEvent(new Event('change'));
            }
        }
        
        function analyzeCurrentColumn() {
            const sheetName = sheetSelector.value;
            const columnName = columnSelector.value;
            if (!sheetName || !columnName) {
                analysisResults.classList.add('hidden');
                analysisPlaceholder.classList.remove('hidden');
                return;
            }

            const columnData = sheetsData[sheetName].map(row => row[columnName]);
            const columnMeta = sheetsMetadata[sheetName].columns.find(c => c.name === columnName);

            if (!columnMeta) return;
            const columnType = columnMeta.userType;
            
            renderAnalysisStats(columnData, columnType);
            renderAnalysisChart(columnData, columnType, columnName);
            
            analysisResults.classList.remove('hidden');
            analysisPlaceholder.classList.add('hidden');
        }
        
        function renderAnalysisStats(data, type) {
            const createCard = (title, value) => `<div class="analysis-stat-card"><h3>${title}</h3><p>${value}</p></div>`;
            let statsHtml = '';
            
            const total = data.length;
            const non_empty = data.filter(d => d !== null && d !== undefined && String(d).trim() !== '').length;
            const unique = new Set(data.filter(d => d !== null && d !== undefined)).size;
            
            statsHtml += createCard('Total Rows', total.toLocaleString());
            statsHtml += createCard('Non-Empty', non_empty.toLocaleString());
            statsHtml += createCard('Unique Values', unique.toLocaleString());
            statsHtml += createCard('Empty Rows', (total - non_empty).toLocaleString());
            
            if (type === 'integer' || type === 'numeric') {
                const numbers = data.map(Number).filter(n => !isNaN(n));
                if (numbers.length > 0) {
                    const sum = numbers.reduce((a, b) => a + b, 0);
                    const avg = sum / numbers.length;
                    statsHtml += createCard('Sum', sum.toLocaleString());
                    statsHtml += createCard('Mean', avg.toFixed(2));
                    statsHtml += createCard('Min', Math.min(...numbers).toLocaleString());
                    statsHtml += createCard('Max', Math.max(...numbers).toLocaleString());
                }
            } else if (type === 'text') {
                const counts = data.reduce((acc, val) => { acc[val] = (acc[val] || 0) + 1; return acc; }, {});
                const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
                if (sorted.length > 0 && sorted[0][0]) statsHtml += createCard('Most Frequent', sorted[0][0]);
            }
            analysisStatsGrid.innerHTML = statsHtml;
        }

        function renderAnalysisChart(data, type, columnName) {
            if (analysisChart) analysisChart.destroy();
            
            const chartColors = ['#4f46e5', '#10b981', '#f97316', '#8b5cf6', '#ec4899', '#f59e0b', '#34d399', '#6d28d9'];
            let chartConfig = { options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } };

            switch(type) {
                case 'integer':
                case 'numeric':
                    const numbers = data.map(Number).filter(n => !isNaN(n));
                    if(numbers.length === 0) { analysisChart = null; return; }
                    const min = Math.min(...numbers);
                    const max = Math.max(...numbers);
                    const binCount = Math.min(10, Math.floor(Math.sqrt(numbers.length)));
                    const binWidth = (max - min) / binCount || 1;
                    const bins = Array(binCount).fill(0);
                    const labels = [];
                    for(let i = 0; i < binCount; i++) {
                        const binStart = min + i * binWidth;
                        labels.push(`${binStart.toLocaleString()}-${(binStart + binWidth).toLocaleString()}`);
                    }
                    numbers.forEach(num => {
                        const binIndex = Math.min(Math.floor((num - min) / binWidth), binCount - 1);
                        if (bins[binIndex] !== undefined) bins[binIndex]++;
                    });
                    chartConfig.type = 'bar';
                    chartConfig.data = { labels, datasets: [{ label: 'Count', data: bins, backgroundColor: chartColors[0] }] };
                    chartConfig.options.scales = { y: { beginAtZero: true, title: { display: true, text: 'Frequency' } } };
                    break;
                
                case 'text':
                    const counts = data.reduce((acc, val) => { if(val) acc[val] = (acc[val] || 0) + 1; return acc; }, {});
                    const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 10);
                    chartConfig.type = 'bar';
                    chartConfig.data = {
                        labels: sorted.map(item => item[0]),
                        datasets: [{ label: 'Count', data: sorted.map(item => item[1]), backgroundColor: chartColors[1] }]
                    };
                    chartConfig.options.indexAxis = 'y';
                    chartConfig.options.scales = { x: { beginAtZero: true, title: { display: true, text: 'Frequency' } } };
                    break;

                case 'boolean':
                    const boolCounts = data.reduce((acc, val) => { 
                        const v = String(val).toLowerCase();
                        if (['true', 't', '1', 'yes'].includes(v)) acc.true++;
                        else if (['false', 'f', '0', 'no'].includes(v)) acc.false++;
                        return acc;
                    }, {true: 0, false: 0});
                    chartConfig.type = 'pie';
                    chartConfig.data = { labels: ['True', 'False'], datasets: [{ data: [boolCounts.true, boolCounts.false], backgroundColor: [chartColors[0], chartColors[4]] }] };
                    chartConfig.options.plugins.legend.display = true;
                    chartConfig.options.plugins.legend.position = 'top';
                    break;

                case 'date':
                case 'timestamptz':
                    const dateCounts = data.reduce((acc, val) => {
                        try {
                            const d = new Date(typeof val === 'number' ? (val - 25569) * 86400 * 1000 : val);
                            if (!isNaN(d)) {
                                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                                acc[key] = (acc[key] || 0) + 1;
                            }
                        } catch(e) {}
                        return acc;
                    }, {});
                    const sortedDates = Object.entries(dateCounts).sort((a,b) => a[0].localeCompare(b[0]));
                    chartConfig.type = 'bar';
                    chartConfig.data = {
                        labels: sortedDates.map(d => d[0]),
                        datasets: [{ label: 'Count', data: sortedDates.map(d => d[1]), backgroundColor: chartColors[3] }]
                    };
                    chartConfig.options.scales = { y: { beginAtZero: true, title: { display: true, text: 'Record Count' } }, x: { title: { display: true, text: 'Month' } } };
                    break;
                default:
                    analysisChart = null; return;
            }
            analysisChart = new Chart(analysisChartCtx, chartConfig);
        }

        // --- 6. FIREBASE DATA VIEWER FUNCTIONS ---
        
        // Auto-load uploaded data function
        async function autoLoadUploadedData() {
            console.log('Auto-loading uploaded data...');
            try {
                // Show loading indicator
                showFirebaseLoading();
                
                // First, refresh collections
                const collectionsFound = await refreshCollections();
                console.log('Collections found:', collectionsFound);
                
                // Auto-select and load the first available collection (which should be most recent)
                if (collectionsFound && collectionSelector.children.length > 1) {
                    const firstCollection = collectionSelector.children[1]; // Skip the "Select..." option
                    collectionSelector.value = firstCollection.value;
                    
                    console.log('Auto-selecting collection:', firstCollection.value);
                    
                    // Show which collection is being loaded
                    showAlert(`Loading data from collection: ${firstCollection.value}`, 'info');
                    
                    await loadCollectionData();
                } else {
                    console.log('No collections found to auto-load');
                    showNoFirebaseData('No uploaded collections found. Upload some data first.');
                }
            } catch (error) {
                console.error('Error auto-loading data:', error);
                showAlert(`Error loading data: ${error.message}`, 'danger');
                showNoFirebaseData('Error loading data. Please try refreshing.');
            }
        }
        
        async function refreshCollections() {
            if (!isFirebaseInitialized || !db) {
                showAlert('Firebase is not connected. Please check your configuration.', 'danger');
                return;
            }
            
            try {
                console.log('Refreshing collections...');
                refreshCollectionsBtn.disabled = true;
                refreshCollectionsBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Loading...';
                
                // Get all collections by trying to list documents from known collections
                // Note: Firestore doesn't have a direct "list collections" method in the web SDK
                const collections = new Set();
                
                // Try to get collections from recent uploads
                const uploadedCollections = JSON.parse(localStorage.getItem('uploadedCollections') || '[]');
                console.log('Uploaded collections from localStorage:', uploadedCollections);
                uploadedCollections.forEach(name => collections.add(name));
                
                // Add any collections from current sheets data
                Object.keys(sheetsData).forEach(sheetName => {
                    collections.add(sanitizeForFirestore(sheetName));
                });
                
                console.log('All collections to check:', Array.from(collections));
                
                // Clear and populate the selector
                collectionSelector.innerHTML = '<option value="">Select a collection...</option>';
                
                const sortedCollections = Array.from(collections).sort((a, b) => {
                    // Prioritize recently uploaded collections
                    const recentCollections = JSON.parse(localStorage.getItem('uploadedCollections') || '[]');
                    const aIsRecent = recentCollections.includes(a);
                    const bIsRecent = recentCollections.includes(b);
                    
                    if (aIsRecent && !bIsRecent) return -1;
                    if (!aIsRecent && bIsRecent) return 1;
                    return a.localeCompare(b); // Alphabetical for same priority
                });
                for (const collectionName of sortedCollections) {
                    try {
                        console.log(`Testing collection: ${collectionName}`);
                        // Test if collection exists by trying to get one document
                        const testQuery = await db.collection(collectionName).limit(1).get();
                        console.log(`Collection ${collectionName} exists, docs:`, testQuery.size);
                        
                        // Collection exists even if empty
                        const option = document.createElement('option');
                        option.value = collectionName;
                        const displayName = truncateHeader(collectionName, 30); // Allow longer for collection names
                        option.textContent = displayName;
                        option.title = collectionName; // Full name on hover
                        collectionSelector.appendChild(option);
                    } catch (error) {
                        console.log(`Collection ${collectionName} error:`, error.message);
                    }
                }
                
                if (collectionSelector.children.length === 1) {
                    showAlert('No collections found. Upload some data first to see collections.', 'info');
                    return false; // No collections found
                }
                
                return true; // Collections found
                
            } catch (error) {
                console.error('Error refreshing collections:', error);
                showAlert('Error loading collections: ' + error.message, 'danger');
                return false;
            } finally {
                refreshCollectionsBtn.disabled = false;
                refreshCollectionsBtn.innerHTML = '<span>Refresh Collections</span>';
            }
        }
        
        async function loadCollectionData() {
            const selectedCollection = collectionSelector.value;
            console.log('Loading collection data for:', selectedCollection);
            
            if (!selectedCollection) {
                console.log('No collection selected');
                hideFirebaseData();
                return;
            }
            
            if (!isFirebaseInitialized || !db) {
                console.error('Firebase not initialized in loadCollectionData');
                showAlert('Firebase is not connected.', 'danger');
                return;
            }
            
            try {
                currentCollection = selectedCollection;
                currentPage = 1;
                lastDocument = null;
                
                showFirebaseLoading();
                console.log('Fetching data from collection:', selectedCollection);
                
                // Get total count (approximate)
                const countQuery = await db.collection(selectedCollection).get();
                totalDocuments = countQuery.size;
                console.log('Total documents in collection:', totalDocuments);
                
                // Get first page of data
                const query = db.collection(selectedCollection).limit(pageSize);
                const snapshot = await query.get();
                
                if (snapshot.empty) {
                    console.log('Collection is empty');
                    showNoFirebaseData('Collection is empty.');
                    return;
                }
                
                const documents = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                console.log('Retrieved documents:', documents.length);
                console.log('First document sample:', documents[0]);
                
                lastDocument = snapshot.docs[snapshot.docs.length - 1];
                
                displayFirebaseData(documents);
                updateCollectionStats(selectedCollection, totalDocuments);
                updatePagination();
                
            } catch (error) {
                console.error('Error loading collection data:', error);
                showAlert('Error loading data: ' + error.message, 'danger');
                hideFirebaseData();
            }
        }
        
        async function changePage(direction) {
            if (!currentCollection || !isFirebaseInitialized || !db) return;
            
            try {
                showFirebaseLoading();
                
                let query = db.collection(currentCollection).limit(pageSize);
                
                if (direction > 0 && lastDocument) {
                    // Next page
                    query = query.startAfter(lastDocument);
                    currentPage++;
                } else if (direction < 0 && currentPage > 1) {
                    // Previous page - this is more complex in Firestore
                    // For simplicity, we'll reload from the beginning and skip to the right page
                    currentPage--;
                    const skipCount = (currentPage - 1) * pageSize;
                    if (skipCount > 0) {
                        const allDocsQuery = await db.collection(currentCollection).limit(skipCount + pageSize).get();
                        const allDocs = allDocsQuery.docs;
                        const startIndex = Math.max(0, skipCount);
                        const pageData = allDocs.slice(startIndex, startIndex + pageSize);
                        
                        const documents = pageData.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        
                        lastDocument = pageData[pageData.length - 1];
                        displayFirebaseData(documents);
                        updatePagination();
                        return;
                    }
                }
                
                const snapshot = await query.get();
                
                if (snapshot.empty) {
                    if (direction > 0) currentPage--; // Revert page increment
                    showAlert('No more data available.', 'info');
                    updatePagination();
                    return;
                }
                
                const documents = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                lastDocument = snapshot.docs[snapshot.docs.length - 1];
                
                displayFirebaseData(documents);
                updatePagination();
                
            } catch (error) {
                console.error('Error changing page:', error);
                showAlert('Error loading page: ' + error.message, 'danger');
            }
        }
        
        function toggleEmptyCells() {
            showEmptyCells = !showEmptyCells;
            
            if (showEmptyCells) {
                toggleEmptyCellsBtn.innerHTML = '<span>Hide Empty Cells</span>';
                toggleEmptyCellsBtn.style.backgroundColor = 'var(--warning-color)';
            } else {
                toggleEmptyCellsBtn.innerHTML = '<span>Show Empty Cells</span>';
                toggleEmptyCellsBtn.style.backgroundColor = 'var(--subtle-text)';
            }
            
            // Re-render the current data with new setting
            if (currentDocuments.length > 0) {
                displayFirebaseData(currentDocuments);
            }
        }
        
        function displayFirebaseData(documents) {
            console.log('Displaying Firebase data, documents:', documents.length);
            
            if (!documents || documents.length === 0) {
                console.log('No documents to display');
                showNoFirebaseData('No documents found in this collection.');
                return;
            }
            
            // Store current documents for toggle functionality
            currentDocuments = documents;
            
            // Get all unique keys from all documents
            const allKeys = new Set();
            documents.forEach(doc => {
                Object.keys(doc).forEach(key => allKeys.add(key));
            });
            
            let headers, cleanedDocuments;
            
            if (showEmptyCells) {
                // Show all data including empty cells
                headers = Array.from(allKeys);
                cleanedDocuments = documents;
            } else {
                // Filter out columns that are mostly empty
                headers = Array.from(allKeys).filter(key => {
                    const nonEmptyCount = documents.filter(doc => !isEmpty(doc[key])).length;
                    const threshold = Math.max(1, Math.floor(documents.length * 0.1)); // At least 10% non-empty
                    return nonEmptyCount >= threshold;
                });
                
                // Clean the data by removing empty cells and normalizing values
                cleanedDocuments = documents.map(doc => {
                    const cleanedDoc = {};
                    headers.forEach(header => {
                        const value = doc[header];
                        if (!isEmpty(value)) {
                            cleanedDoc[header] = value;
                        }
                    });
                    return cleanedDoc;
                }).filter(doc => {
                    // Remove completely empty documents
                    if (Object.keys(doc).length === 0) return false;
                    
                    // Remove documents that are mostly empty (more than 70% empty)
                    if (isRowMostlyEmpty(doc, 0.7)) return false;
                    
                    // Keep documents with at least 2 non-empty fields (excluding id)
                    const nonIdFields = Object.keys(doc).filter(key => key !== 'id');
                    return nonIdFields.length >= 1;
                });
            }
            
            if (cleanedDocuments.length === 0 && !showEmptyCells) {
                showNoFirebaseData('No meaningful data found after cleaning empty cells.');
                return;
            }
            
            // Create table with data
            const thead = `<thead><tr>${headers.map(h => `<th>${formatHeaderForDisplay(h)}</th>`).join('')}</tr></thead>`;
            const tbody = `<tbody>${cleanedDocuments.map(doc => 
                `<tr>${headers.map(h => {
                    const value = doc[h];
                    let displayValue = '';
                    let cellClass = '';
                    
                    if (showEmptyCells || !isEmpty(value)) {
                        if (isEmpty(value)) {
                            displayValue = '—'; // Em dash for empty cells when showing all
                            cellClass = 'empty-cell';
                        } else if (typeof value === 'object') {
                            displayValue = JSON.stringify(value);
                        } else {
                            displayValue = String(value).trim();
                        }
                        // Truncate long values
                        if (displayValue.length > 100) {
                            displayValue = displayValue.substring(0, 100) + '...';
                        }
                    }
                    return `<td class="${cellClass}" title="${displayValue}">${displayValue}</td>`;
                }).join('')}</tr>`
            ).join('')}</tbody>`;
            
            firebaseDataTable.innerHTML = thead + tbody;
            
            // Show cleaning stats if significant cleaning occurred and not showing empty cells
            if (!showEmptyCells) {
                const originalCellCount = documents.length * allKeys.size;
                const cleanedCellCount = cleanedDocuments.reduce((count, doc) => count + Object.keys(doc).length, 0);
                const removedCells = originalCellCount - cleanedCellCount;
                
                if (removedCells > 0) {
                    const cleaningInfo = document.createElement('div');
                    cleaningInfo.className = 'alert alert-info';
                    cleaningInfo.style.marginBottom = '1rem';
                    cleaningInfo.innerHTML = `<strong>Data Cleaned:</strong> Removed ${removedCells} empty cells and ${allKeys.size - headers.length} empty columns for better readability.`;
                    
                    const container = firebaseDataTableContainer.parentNode;
                    const existingAlert = container.querySelector('.alert');
                    if (existingAlert) {
                        existingAlert.remove();
                    }
                    container.insertBefore(cleaningInfo, firebaseDataTableContainer);
                }
            } else {
                // Remove cleaning info when showing all data
                const container = firebaseDataTableContainer.parentNode;
                const existingAlert = container.querySelector('.alert');
                if (existingAlert) {
                    existingAlert.remove();
                }
            }
            
            // Show the table
            firebaseDataLoading.classList.add('hidden');
            firebaseDataTableContainer.classList.remove('hidden');
            firebaseDataPagination.classList.remove('hidden');
            noFirebaseData.classList.add('hidden');
        }
        
        function updateCollectionStats(collectionName, documentCount) {
            collectionNameStat.textContent = collectionName;
            totalDocumentsStat.textContent = documentCount.toLocaleString();
            lastUpdatedStat.textContent = new Date().toLocaleString();
            collectionStats.classList.remove('hidden');
        }
        
        function updatePagination() {
            const totalPages = Math.max(1, Math.ceil(totalDocuments / pageSize));
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;
        }
        
        function showFirebaseLoading() {
            firebaseDataLoading.classList.remove('hidden');
            firebaseDataTableContainer.classList.add('hidden');
            firebaseDataPagination.classList.add('hidden');
            noFirebaseData.classList.add('hidden');
        }
        
        function showNoFirebaseData(message = 'Select a collection to view its data.') {
            firebaseDataLoading.classList.add('hidden');
            firebaseDataTableContainer.classList.add('hidden');
            firebaseDataPagination.classList.add('hidden');
            noFirebaseData.classList.remove('hidden');
            noFirebaseData.textContent = message;
            collectionStats.classList.add('hidden');
        }
        
        function hideFirebaseData() {
            firebaseDataLoading.classList.add('hidden');
            firebaseDataTableContainer.classList.add('hidden');
            firebaseDataPagination.classList.add('hidden');
            noFirebaseData.classList.remove('hidden');
            collectionStats.classList.add('hidden');
        }
        
        function initializeMetadata(allSheetsData) {
            sheetsMetadata = {};
            for (const sheetName in allSheetsData) {
                const data = allSheetsData[sheetName]; 
                if (!data || data.length === 0) continue;
                
                const headers = Object.keys(data[0] || {});
                const sanitizedNames = new Set();
                const columnsMetadata = [];

                headers.forEach(header => {
                    // The header should already be cleaned, but ensure Firestore compatibility
                    let sanitizedName = sanitizeForFirestore(header);
                    
                    // Handle collisions to ensure unique field names
                    let counter = 1;
                    let finalName = sanitizedName;
                    while (sanitizedNames.has(finalName)) {
                        finalName = `${sanitizedName}_${counter}`;
                        counter++;
                    }
                    sanitizedNames.add(finalName);
                    
                    const values = data.map(row => row[header]);
                    const inferredType = inferTypeForColumn(values);
                    
                    columnsMetadata.push({ 
                        name: header, 
                        sanitizedName: finalName,
                        userType: inferredType,
                        displayName: header // Keep the cleaned display name
                    });
                });
                
                sheetsMetadata[sheetName] = { columns: columnsMetadata, primaryKey: null };
            }
        }

        function inferTypeForColumn(values) {
            let isInteger = true, isNumeric = true, isBoolean = true;
            const sample = values.slice(0, 50).filter(v => v !== null && v !== undefined && String(v).trim() !== '');
            if (sample.length === 0) return 'text';
            for (const val of sample) {
                const sVal = String(val);
                if (isInteger && !/^-?\d+$/.test(sVal)) isInteger = false;
                if (isNumeric && isNaN(Number(val))) isNumeric = false;
                if (isBoolean && !['true', 'false', 't', 'f', 'yes', 'no', '1', '0'].includes(sVal.toLowerCase())) isBoolean = false;
            }
            if (isInteger) return 'integer'; if (isNumeric) return 'numeric'; if (isBoolean) return 'boolean';
            const isDateParsable = sample.every(v => !isNaN(Date.parse(String(v))) && isNaN(Number(v)));
            if (isDateParsable) {
                const hasTimeComponent = sample.some(v => String(v).match(/\d{1,2}:\d{2}/));
                return hasTimeComponent ? 'timestamptz' : 'date';
            }
            return 'text';
        }

        function showAlert(message, type = 'danger') {
            alertContainer.innerHTML = '';
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`; alertDiv.innerHTML = message;
            alertContainer.appendChild(alertDiv);
            void alertDiv.offsetWidth; alertDiv.classList.add('show');
        }

        function setLoadingState(isLoading) {
            uploadBtn.disabled = isLoading;
            btnText.classList.toggle('hidden', isLoading);
            btnSpinner.classList.toggle('hidden', !isLoading);
        }

        function switchView(viewName) {
            // Hide all main views
            dataView.classList.add('hidden');
            homeView.classList.add('hidden');
            industryView.classList.add('hidden');
            newsView.classList.add('hidden');
            regionalView.classList.add('hidden');
            eventsView.classList.add('hidden');
            healthView.classList.add('hidden');
            contactView.classList.add('hidden');
            aboutView.classList.add('hidden');
            
            // Remove active class from all main tabs
            dataTabBtn.classList.remove('active');
            homeTabBtn.classList.remove('active');
            industryTabBtn.classList.remove('active');
            newsTabBtn.classList.remove('active');
            regionalTabBtn.classList.remove('active');
            eventsTabBtn.classList.remove('active');
            healthTabBtn.classList.remove('active');
            contactTabBtn.classList.remove('active');
            aboutTabBtn.classList.remove('active');
            
            // Show the selected view
            if (viewName === 'data') {
                dataView.classList.remove('hidden');
                dataTabBtn.classList.add('active');
                // When switching to data view, show the ingest sub-view by default
                switchDataSubView('ingest');
            } else if (viewName === 'home') {
                homeView.classList.remove('hidden');
                homeTabBtn.classList.add('active');
            } else if (viewName === 'industry') {
                industryView.classList.remove('hidden');
                industryTabBtn.classList.add('active');
            } else if (viewName === 'news') {
                newsView.classList.remove('hidden');
                newsTabBtn.classList.add('active');
            } else if (viewName === 'regional') {
                regionalView.classList.remove('hidden');
                regionalTabBtn.classList.add('active');
            } else if (viewName === 'events') {
                eventsView.classList.remove('hidden');
                eventsTabBtn.classList.add('active');
            } else if (viewName === 'health') {
                healthView.classList.remove('hidden');
                healthTabBtn.classList.add('active');
            } else if (viewName === 'contact') {
                contactView.classList.remove('hidden');
                contactTabBtn.classList.add('active');
            } else if (viewName === 'about') {
                aboutView.classList.remove('hidden');
                aboutTabBtn.classList.add('active');
                // When switching to about view, show the about-us sub-view by default
                switchAboutUsSubView('about-us');
            }
        }

        function switchDataSubView(viewName) {
            // Hide all data sub-views
            ingestSubView.classList.add('hidden');
            dashboardSubView.classList.add('hidden');
            uploadedDataSubView.classList.add('hidden');
            excelSubView.classList.add('hidden');
            
            // Remove active class from all data sub-tabs
            ingestSubTabBtn.classList.remove('active');
            dashboardSubTabBtn.classList.remove('active');
            uploadedDataSubTabBtn.classList.remove('active');
            excelSubTabBtn.classList.remove('active');
            
            // Show the selected sub-view
            if (viewName === 'ingest') {
                ingestSubView.classList.remove('hidden');
                ingestSubTabBtn.classList.add('active');
            } else if (viewName === 'dashboard') {
                dashboardSubView.classList.remove('hidden');
                dashboardSubTabBtn.classList.add('active');
            } else if (viewName === 'uploaded-data') {
                uploadedDataSubView.classList.remove('hidden');
                uploadedDataSubTabBtn.classList.add('active');
                // Auto-load data when switching to this tab
                if (isFirebaseInitialized) {
                    autoLoadUploadedData();
                }
            } else if (viewName === 'excel') {
                excelSubView.classList.remove('hidden');
                excelSubTabBtn.classList.add('active');
            }
        }

        function switchAboutUsSubView(viewName) {
            // Hide all About Us sub-views
            aboutUsSubView.classList.add('hidden');
            developerSubView.classList.add('hidden');
            aboutMeSubView.classList.add('hidden');
            
            // Remove active class from all About Us sub-tabs
            aboutUsSubTabBtn.classList.remove('active');
            developerSubTabBtn.classList.remove('active');
            aboutMeSubTabBtn.classList.remove('active');
            
            // Show the selected sub-view
            if (viewName === 'about-us') {
                aboutUsSubView.classList.remove('hidden');
                aboutUsSubTabBtn.classList.add('active');
            } else if (viewName === 'developer') {
                developerSubView.classList.remove('hidden');
                developerSubTabBtn.classList.add('active');
            } else if (viewName === 'about-me') {
                aboutMeSubView.classList.remove('hidden');
                aboutMeSubTabBtn.classList.add('active');
            }
        }

        function resetUI(isFullReset = false) {
            previewSection.classList.add('hidden'); 
            sheetTabsContainer.innerHTML = '';
            previewTable.innerHTML = '';
            uploadBtn.disabled = true; 
            sheetsData = {}; 
            sheetsMetadata = {}; 
            currentSheetName = '';
            
            // Hide header info
            const headerInfo = document.getElementById('header-info');
            if (headerInfo) headerInfo.classList.add('hidden');
            
            dropZone.classList.remove('error');
            if (!isFullReset) {
                alertContainer.innerHTML = '';
            }
            
            if (isFullReset) {
                fileInput.value = '';
                dropZone.innerHTML = DROP_ZONE_DEFAULT_HTML;
            }
            
            dashboardSubTabBtn.disabled = true;
            
            // Reset uploaded data tab if no collections exist
            const uploadedCollections = JSON.parse(localStorage.getItem('uploadedCollections') || '[]');
            uploadedDataSubTabBtn.disabled = uploadedCollections.length === 0;
            
            switchDataSubView('ingest');
            totalSheetsStat.textContent = '0'; 
            totalRowsStat.textContent = '0'; 
            totalColsStat.textContent = '0';
            if (rowsPieChart) { rowsPieChart.destroy(); rowsPieChart = null; }
            if (typesPieChart) { typesPieChart.destroy(); typesPieChart = null; }

            columnAnalysisSection.classList.add('hidden');
            analysisResults.classList.add('hidden');
            analysisPlaceholder.classList.remove('hidden');
            if (analysisChart) { analysisChart.destroy(); analysisChart = null; }
            sheetSelector.innerHTML = ''; 
            columnSelector.innerHTML = '';
        }

        function updateTargetTableInfo(sheetName) {
            if (sheetName) {
                targetTableNameEl.textContent = sanitizeForFirestore(sheetName);
                targetTableContainer.classList.remove('hidden');
            } else {
                targetTableContainer.classList.add('hidden');
            }
        }
        
        function sanitizeForFirestore(name) {
            if (typeof name !== 'string' || name.trim() === '') return 'unnamed_field';
            
            const sanitized = name.trim().toLowerCase()
                .replace(/[^a-z0-9_]/g, '_') // Replace invalid chars with _
                .replace(/_{2,}/g, '_')     // Collapse consecutive underscores
                .replace(/^_*|_*$/g, '')      // Trim leading/trailing underscores
                .replace(/^[0-9]/, match => `_${match}`); // Prepend _ to leading numbers

            return sanitized === '' ? 'unnamed_field' : sanitized;
        }
        
        function toggleTheme() {
            const root = document.documentElement;
            const isDark = themeToggleCheckbox.checked;
            
            if (isDark) {
                // Switch to dark theme
                root.style.setProperty('--background-color', '#1e293b');
                root.style.setProperty('--card-bg-color', '#334155');
                root.style.setProperty('--text-color', '#e2e8f0');
                root.style.setProperty('--heading-color', '#f1f5f9');
                root.style.setProperty('--border-color', '#475569');
                root.style.setProperty('--subtle-text', '#94a3b8');
            } else {
                // Switch to light theme
                root.style.setProperty('--background-color', '#f8fafc');
                root.style.setProperty('--card-bg-color', '#ffffff');
                root.style.setProperty('--text-color', '#334155');
                root.style.setProperty('--heading-color', '#0f172a');
                root.style.setProperty('--border-color', '#e2e8f0');
                root.style.setProperty('--subtle-text', '#64748b');
            }
        }
    </script>
</body>
</html>
</html>